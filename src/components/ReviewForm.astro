---
/**
 * Review Submission Form Component
 *
 * Allows authenticated users who have purchased a course to submit reviews.
 * Features:
 * - Star rating selector (1-5 stars)
 * - Comment textarea
 * - Client-side validation
 * - Loading states
 * - Success/error messages
 * - Styled with Tailwind CSS
 *
 * Props:
 * - courseId: UUID of the course being reviewed
 * - userId: UUID of the authenticated user (or null if not authenticated)
 * - hasPurchased: Boolean indicating if user has purchased the course
 * - existingReview: Existing review object if user has already reviewed
 */

import { useTranslations } from '@/lib/pageTranslations';

const { locale, t } = useTranslations(Astro.locals);

interface Props {
  courseId: string;
  userId: string | null;
  hasPurchased: boolean;
  existingReview?: {
    id: string;
    rating: number;
    comment: string;
    isApproved: boolean;
  } | null;
}

const { courseId, userId, hasPurchased, existingReview } = Astro.props;

// Determine if form should be shown
const canSubmitReview = userId && hasPurchased && !existingReview;
const hasExistingReview = !!existingReview;
---

<div class="bg-white rounded-lg shadow-md p-6 mb-8" data-locale={locale} data-rating-labels={JSON.stringify([t('reviews.ratingLabels.poor'), t('reviews.ratingLabels.fair'), t('reviews.ratingLabels.good'), t('reviews.ratingLabels.veryGood'), t('reviews.ratingLabels.excellent')])}>
  <h2 class="text-2xl font-bold text-gray-900 mb-4">{t('reviews.writeReview')}</h2>

  {!userId && (
    <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
      <p class="text-blue-800">
        {t('reviews.loginToReview').split('log in')[0]}<a href="/login" class="font-semibold underline hover:text-blue-900">{t('common.login').toLowerCase()}</a>{t('reviews.loginToReview').split('log in')[1] || ''}
      </p>
    </div>
  )}

  {userId && !hasPurchased && !hasExistingReview && (
    <div class="bg-amber-50 border border-amber-200 rounded-md p-4">
      <p class="text-amber-800">
        {t('reviews.mustPurchase')}
      </p>
    </div>
  )}

  {hasExistingReview && (
    <div class="bg-green-50 border border-green-200 rounded-md p-4">
      <p class="text-green-800 font-semibold mb-2">{t('reviews.alreadyReviewed')}</p>
      <div class="flex items-center gap-2 mb-2">
        <span class="text-sm text-gray-600">{t('reviews.yourRating')}:</span>
        <div class="flex gap-1">
          {Array.from({ length: 5 }, (_, i) => i + 1).map((star) => (
            <svg
              class={`w-5 h-5 ${star <= (existingReview?.rating || 0) ? 'text-yellow-400' : 'text-gray-300'}`}
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
            </svg>
          ))}
        </div>
      </div>
      {existingReview?.comment && (
        <div class="text-sm text-gray-700 mt-2">
          <span class="font-semibold">{t('reviews.yourReview')}:</span>
          <p class="mt-1 italic">&ldquo;{existingReview.comment}&rdquo;</p>
        </div>
      )}
      {!existingReview?.isApproved && (
        <p class="text-sm text-amber-600 mt-2">
          {t('reviews.pendingApproval')}
        </p>
      )}
    </div>
  )}

  {canSubmitReview && (
    <form id="review-form" class="space-y-6">
      <input type="hidden" name="courseId" value={courseId} />
      <input type="hidden" name="userId" value={userId} />

      <!-- Rating Selection -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          {t('reviews.rating')} <span class="text-red-500">*</span>
        </label>
        <div class="flex gap-2 items-center">
          <div id="star-rating" class="flex gap-1 cursor-pointer" role="radiogroup" aria-label="Rating">
            {Array.from({ length: 5 }, (_, i) => i + 1).map((star) => (
              <button
                type="button"
                data-star={star}
                class="star-button focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded"
                aria-label={`Rate ${star} star${star > 1 ? 's' : ''}`}
                role="radio"
                aria-checked="false"
              >
                <svg
                  class="w-10 h-10 text-gray-300 hover:text-yellow-400 transition-colors duration-150"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
              </button>
            ))}
          </div>
          <span id="rating-text" class="text-sm text-gray-600 ml-2"></span>
        </div>
        <input type="hidden" id="rating-input" name="rating" value="" required />
        <p id="rating-error" class="text-red-500 text-sm mt-1 hidden" data-message={t('reviews.selectRating')}>{t('reviews.selectRating')}</p>
      </div>

      <!-- Comment Textarea -->
      <div>
        <label for="comment" class="block text-sm font-semibold text-gray-700 mb-2">
          {t('reviews.reviewOptional')}
        </label>
        <textarea
          id="comment"
          name="comment"
          rows="5"
          maxlength="1000"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
          placeholder={t('reviews.reviewPlaceholder')}
        ></textarea>
        <div class="flex justify-between items-center mt-1">
          <p class="text-xs text-gray-500">{t('reviews.maxCharacters', { max: 1000 })}</p>
          <p id="char-count" class="text-xs text-gray-500">0 / 1000</p>
        </div>
      </div>

      <!-- Error Message -->
      <div id="form-error" class="bg-red-50 border border-red-200 rounded-md p-4 hidden">
        <p class="text-red-800 text-sm"></p>
      </div>

      <!-- Success Message -->
      <div id="form-success" class="bg-green-50 border border-green-200 rounded-md p-4 hidden">
        <p class="text-green-800 text-sm">
          {t('reviews.thankYouReview')}
        </p>
      </div>

      <!-- Submit Button -->
      <div>
        <button
          type="submit"
          id="submit-button"
          class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed"
          data-submit-text={t('reviews.submitReview')}
          data-submitting-text={t('reviews.submitting')}
        >
          <span id="submit-text">{t('reviews.submitReview')}</span>
          <span id="submit-loading" class="hidden">
            <svg class="animate-spin h-5 w-5 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            {t('reviews.submitting')}
          </span>
        </button>
      </div>
    </form>
  )}
</div>

<script>
  // Star rating functionality
  const starRating = document.getElementById('star-rating');
  const ratingInput = document.getElementById('rating-input') as HTMLInputElement;
  const ratingText = document.getElementById('rating-text');
  const ratingError = document.getElementById('rating-error');
  const stars = document.querySelectorAll('.star-button');

  let selectedRating = 0;

  // Star rating interaction
  stars.forEach((star, index) => {
    const starButton = star as HTMLButtonElement;
    const starValue = index + 1;

    // Click to select rating
    starButton.addEventListener('click', (e) => {
      e.preventDefault();
      selectedRating = starValue;
      updateStarDisplay();
      if (ratingInput) ratingInput.value = selectedRating.toString();
      if (ratingError) ratingError.classList.add('hidden');
    });

    // Hover effects
    starButton.addEventListener('mouseenter', () => {
      highlightStars(starValue);
    });

    starButton.addEventListener('mouseleave', () => {
      highlightStars(selectedRating);
    });
  });

  // If mouse leaves the entire rating container
  if (starRating) {
    starRating.addEventListener('mouseleave', () => {
      highlightStars(selectedRating);
    });
  }

  function highlightStars(count: number) {
    stars.forEach((star, index) => {
      const svg = star.querySelector('svg');
      if (svg) {
        if (index < count) {
          svg.classList.remove('text-gray-300');
          svg.classList.add('text-yellow-400');
        } else {
          svg.classList.remove('text-yellow-400');
          svg.classList.add('text-gray-300');
        }
      }
    });

    // Update text display
    if (ratingText && count > 0) {
      const container = document.querySelector('[data-rating-labels]');
      const labels = container ? JSON.parse(container.getAttribute('data-rating-labels') || '[]') : ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
      ratingText.textContent = labels[count - 1];
    } else if (ratingText) {
      ratingText.textContent = '';
    }
  }

  function updateStarDisplay() {
    highlightStars(selectedRating);
    // Update ARIA attributes
    stars.forEach((star, index) => {
      star.setAttribute('aria-checked', (index < selectedRating) ? 'true' : 'false');
    });
  }

  // Character counter
  const commentTextarea = document.getElementById('comment') as HTMLTextAreaElement;
  const charCount = document.getElementById('char-count');

  if (commentTextarea && charCount) {
    commentTextarea.addEventListener('input', () => {
      const count = commentTextarea.value.length;
      charCount.textContent = `${count} / 1000`;

      // Change color when approaching limit
      if (count > 900) {
        charCount.classList.add('text-red-500');
        charCount.classList.remove('text-gray-500');
      } else {
        charCount.classList.remove('text-red-500');
        charCount.classList.add('text-gray-500');
      }
    });
  }

  // Form submission
  const form = document.getElementById('review-form') as HTMLFormElement;
  const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
  const submitText = document.getElementById('submit-text');
  const submitLoading = document.getElementById('submit-loading');
  const formError = document.getElementById('form-error');
  const formSuccess = document.getElementById('form-success');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate rating
      if (!selectedRating || selectedRating < 1 || selectedRating > 5) {
        if (ratingError) {
          ratingError.classList.remove('hidden');
        }
        return;
      }

      // Hide previous messages
      if (formError) formError.classList.add('hidden');
      if (formSuccess) formSuccess.classList.add('hidden');

      // Show loading state
      if (submitButton) submitButton.disabled = true;
      if (submitText) submitText.classList.add('hidden');
      if (submitLoading) submitLoading.classList.remove('hidden');

      try {
        const formData = new FormData(form);
        const data = {
          courseId: formData.get('courseId'),
          userId: formData.get('userId'),
          rating: selectedRating,
          comment: formData.get('comment') || undefined,
        };

        const response = await fetch('/api/reviews/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error?.message || 'Failed to submit review');
        }

        // Show success message
        if (formSuccess) {
          formSuccess.classList.remove('hidden');
        }

        // Reset form
        form.reset();
        selectedRating = 0;
        updateStarDisplay();
        if (ratingInput) ratingInput.value = '';
        if (charCount) charCount.textContent = '0 / 1000';

        // Reload page after 2 seconds to show the new review status
        setTimeout(() => {
          window.location.reload();
        }, 2000);

      } catch (error) {
        // Show error message
        if (formError) {
          const errorText = formError.querySelector('p');
          if (errorText) {
            errorText.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.';
          }
          formError.classList.remove('hidden');
        }
      } finally {
        // Reset button state
        if (submitButton) submitButton.disabled = false;
        if (submitText) submitText.classList.remove('hidden');
        if (submitLoading) submitLoading.classList.add('hidden');
      }
    });
  }
</script>
