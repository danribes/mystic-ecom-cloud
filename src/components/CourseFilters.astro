---
/**
 * CourseFilters Component
 * Advanced filtering sidebar for course catalog
 * Supports category, price range, level, and rating filters
 */

interface Props {
  currentCategory: string;
  currentLevel: string;
  currentMinPrice: string;
  currentMaxPrice: string;
  currentMinRating: string;
  categories: string[];
}

const {
  currentCategory,
  currentLevel,
  currentMinPrice,
  currentMaxPrice,
  currentMinRating,
  categories,
} = Astro.props;

// Check if any filters are active
const hasActiveFilters =
  currentCategory !== 'all' ||
  currentLevel !== 'all' ||
  currentMinPrice !== '' ||
  currentMaxPrice !== '' ||
  currentMinRating !== '';
---

<aside class="w-full flex-shrink-0 lg:w-64">
  <div class="sticky top-4 rounded-lg border border-border bg-background p-lg">
    <div class="mb-lg flex items-center justify-between">
      <h2 class="text-lg font-semibold text-text">Filters</h2>
      {hasActiveFilters && (
        <a
          href="/courses"
          class="text-sm text-primary hover:underline"
        >
          Clear all
        </a>
      )}
    </div>

    <form id="course-filters" action="/courses" method="GET" class="space-y-lg">
      <!-- Category Filter -->
      <div>
        <h3 class="mb-sm text-sm font-medium text-text">Category</h3>
        <div class="space-y-xs">
          <label class="filter-label">
            <input
              type="radio"
              name="category"
              value="all"
              checked={currentCategory === 'all'}
              class="filter-radio"
            />
            <span class="filter-radio-custom"></span>
            <span class="text-sm text-text-light">All Categories</span>
          </label>

          {categories.map((category) => (
            <label class="filter-label">
              <input
                type="radio"
                name="category"
                value={category}
                checked={currentCategory === category}
                class="filter-radio"
              />
              <span class="filter-radio-custom"></span>
              <span class="text-sm capitalize text-text-light">{category}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- Level Filter -->
      <div class="border-t border-border pt-lg">
        <h3 class="mb-sm text-sm font-medium text-text">Level</h3>
        <div class="space-y-xs">
          <label class="filter-label">
            <input
              type="radio"
              name="level"
              value="all"
              checked={currentLevel === 'all'}
              class="filter-radio"
            />
            <span class="filter-radio-custom"></span>
            <span class="text-sm text-text-light">All Levels</span>
          </label>

          <label class="filter-label">
            <input
              type="radio"
              name="level"
              value="beginner"
              checked={currentLevel === 'beginner'}
              class="filter-radio"
            />
            <span class="filter-radio-custom"></span>
            <span class="text-sm text-text-light">Beginner</span>
          </label>

          <label class="filter-label">
            <input
              type="radio"
              name="level"
              value="intermediate"
              checked={currentLevel === 'intermediate'}
              class="filter-radio"
            />
            <span class="filter-radio-custom"></span>
            <span class="text-sm text-text-light">Intermediate</span>
          </label>

          <label class="filter-label">
            <input
              type="radio"
              name="level"
              value="advanced"
              checked={currentLevel === 'advanced'}
              class="filter-radio"
            />
            <span class="filter-radio-custom"></span>
            <span class="text-sm text-text-light">Advanced</span>
          </label>
        </div>
      </div>

      <!-- Price Range Filter -->
      <div class="border-t border-border pt-lg">
        <h3 class="mb-sm text-sm font-medium text-text">Price Range</h3>
        <div class="space-y-sm">
          <div>
            <label for="minPrice" class="mb-xs block text-xs text-text-light">
              Minimum Price
            </label>
            <div class="relative">
              <span class="absolute left-sm top-1/2 -translate-y-1/2 text-sm text-text-light">
                $
              </span>
              <input
                type="number"
                id="minPrice"
                name="minPrice"
                value={currentMinPrice}
                min="0"
                step="0.01"
                placeholder="0.00"
                class="w-full rounded-md border border-border py-sm pl-6 pr-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              />
            </div>
          </div>

          <div>
            <label for="maxPrice" class="mb-xs block text-xs text-text-light">
              Maximum Price
            </label>
            <div class="relative">
              <span class="absolute left-sm top-1/2 -translate-y-1/2 text-sm text-text-light">
                $
              </span>
              <input
                type="number"
                id="maxPrice"
                name="maxPrice"
                value={currentMaxPrice}
                min="0"
                step="0.01"
                placeholder="No max"
                class="w-full rounded-md border border-border py-sm pl-6 pr-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Rating Filter -->
      <div class="border-t border-border pt-lg">
        <h3 class="mb-sm text-sm font-medium text-text">Minimum Rating</h3>
        <div class="space-y-xs">
          <label class="filter-label">
            <input
              type="radio"
              name="minRating"
              value=""
              checked={currentMinRating === ''}
              class="filter-radio"
            />
            <span class="filter-radio-custom"></span>
            <span class="text-sm text-text-light">All Ratings</span>
          </label>

          {[4, 3, 2, 1].map((rating) => (
            <label class="filter-label">
              <input
                type="radio"
                name="minRating"
                value={rating.toString()}
                checked={currentMinRating === rating.toString()}
                class="filter-radio"
              />
              <span class="filter-radio-custom"></span>
              <span class="flex items-center text-sm text-text-light">
                <span class="flex text-yellow-400">
                  {Array.from({ length: rating }).map(() => (
                    <svg class="h-4 w-4 fill-current" viewBox="0 0 20 20">
                      <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" />
                    </svg>
                  ))}
                  {Array.from({ length: 5 - rating }).map(() => (
                    <svg class="h-4 w-4 fill-current text-gray-300" viewBox="0 0 20 20">
                      <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" />
                    </svg>
                  ))}
                </span>
                <span class="ml-1">& up</span>
              </span>
            </label>
          ))}
        </div>
      </div>

      <!-- Apply Filters Button -->
      <div class="pt-lg">
        <button
          type="submit"
          class="w-full rounded-md bg-primary px-md py-sm text-sm font-medium text-white transition-colors hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
        >
          Apply Filters
        </button>
      </div>
    </form>
  </div>
</aside>

<style>
  /* Custom radio button styling - overrides global min-size */
  .filter-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.25rem 0;
    min-height: auto;
  }

  .filter-radio {
    /* Hide the actual radio but keep it accessible */
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
    min-width: 0 !important;
    min-height: 0 !important;
  }

  .filter-radio-custom {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1rem;
    height: 1rem;
    min-width: 1rem;
    min-height: 1rem;
    border: 2px solid var(--color-border-dark);
    border-radius: 50%;
    margin-right: 0.5rem;
    flex-shrink: 0;
    transition: all 0.15s ease-in-out;
  }

  .filter-radio:checked + .filter-radio-custom {
    border-color: var(--color-primary);
    background-color: var(--color-primary);
  }

  .filter-radio:checked + .filter-radio-custom::after {
    content: '';
    display: block;
    width: 0.375rem;
    height: 0.375rem;
    background-color: white;
    border-radius: 50%;
  }

  .filter-radio:focus-visible + .filter-radio-custom {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .filter-label:hover .filter-radio-custom {
    border-color: var(--color-primary);
  }
</style>

<script>
  // Auto-submit form when radio buttons change (instant filtering)
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('course-filters') as HTMLFormElement;
    if (!form) return;

    const radioInputs = form.querySelectorAll('input[type="radio"]');

    radioInputs.forEach((radio) => {
      radio.addEventListener('change', () => {
        form.submit();
      });
    });

    // Validate price inputs
    const minPriceInput = form.querySelector('#minPrice') as HTMLInputElement;
    const maxPriceInput = form.querySelector('#maxPrice') as HTMLInputElement;

    if (minPriceInput && maxPriceInput) {
      minPriceInput.addEventListener('input', () => {
        if (minPriceInput.value && parseFloat(minPriceInput.value) < 0) {
          minPriceInput.value = '0';
        }
      });

      maxPriceInput.addEventListener('input', () => {
        if (maxPriceInput.value && parseFloat(maxPriceInput.value) < 0) {
          maxPriceInput.value = '0';
        }
      });
    }
  });
</script>
