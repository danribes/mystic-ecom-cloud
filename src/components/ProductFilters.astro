---
/**
 * ProductFilters Component
 *
 * Advanced filter sidebar for digital products catalog.
 * Supports product type (format), price range, file size, and sorting.
 * Uses instant filtering for better UX on type and sort changes.
 */

interface Props {
  currentType?: string;
  currentMinPrice?: string;
  currentMaxPrice?: string;
  currentMinSize?: string;
  currentMaxSize?: string;
  currentSort?: string;
}

const {
  currentType = 'all',
  currentMinPrice = '',
  currentMaxPrice = '',
  currentMinSize = '',
  currentMaxSize = '',
  currentSort = 'newest',
} = Astro.props;

// Check if any filters are active
const hasActiveFilters =
  currentType !== 'all' ||
  currentMinPrice !== '' ||
  currentMaxPrice !== '' ||
  currentMinSize !== '' ||
  currentMaxSize !== '';

// Product type options with icons
const productTypes = [
  { value: 'pdf', label: 'PDF Documents', icon: 'ðŸ“„' },
  { value: 'audio', label: 'Audio Files', icon: 'ðŸŽµ' },
  { value: 'video', label: 'Video Content', icon: 'ðŸŽ¥' },
  { value: 'ebook', label: 'E-Books', icon: 'ðŸ“š' },
];
---

<aside class="sticky top-4 w-full rounded-lg border border-border bg-background p-lg lg:w-64">
  <div class="mb-lg flex items-center justify-between">
    <h2 class="text-lg font-semibold text-text">Filters</h2>
    {hasActiveFilters && (
      <a
        href="/products"
        class="text-sm text-primary hover:underline"
      >
        Clear all
      </a>
    )}
  </div>

  <form id="product-filters" action="/products" method="GET" class="space-y-lg">

    <!-- Product Type (Format) Filter -->
    <div>
      <h3 class="mb-sm text-sm font-medium text-text">Product Type</h3>
      <div class="space-y-xs">
        <label class="filter-label group">
          <input
            type="radio"
            name="type"
            value="all"
            checked={currentType === 'all'}
            class="filter-radio"
          />
          <span class="filter-radio-custom"></span>
          <span class="text-sm text-text-light group-hover:text-text">
            All Products
          </span>
        </label>

        {productTypes.map(({ value, label, icon }) => (
          <label class="filter-label group">
            <input
              type="radio"
              name="type"
              value={value}
              checked={currentType === value}
              class="filter-radio"
            />
            <span class="filter-radio-custom"></span>
            <span class="text-sm text-text-light group-hover:text-text">
              {icon} {label}
            </span>
          </label>
        ))}
      </div>
    </div>

    <!-- Price Range Filter -->
    <div class="border-t border-border pt-lg">
      <h3 class="mb-sm text-sm font-medium text-text">Price Range</h3>

      <div class="space-y-sm">
        <div>
          <label for="minPrice" class="mb-xs block text-xs text-text-light">
            Min Price
          </label>
          <div class="relative">
            <span class="absolute left-sm top-1/2 -translate-y-1/2 text-text-light">$</span>
            <input
              type="number"
              id="minPrice"
              name="minPrice"
              value={currentMinPrice}
              min="0"
              step="0.01"
              placeholder="0.00"
              class="w-full rounded-md border border-border py-sm pl-6 pr-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
            />
          </div>
        </div>

        <div>
          <label for="maxPrice" class="mb-xs block text-xs text-text-light">
            Max Price
          </label>
          <div class="relative">
            <span class="absolute left-sm top-1/2 -translate-y-1/2 text-text-light">$</span>
            <input
              type="number"
              id="maxPrice"
              name="maxPrice"
              value={currentMaxPrice}
              min="0"
              step="0.01"
              placeholder="Any"
              class="w-full rounded-md border border-border py-sm pl-6 pr-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- File Size Range Filter -->
    <div class="border-t border-border pt-lg">
      <h3 class="mb-sm text-sm font-medium text-text">File Size (MB)</h3>

      <div class="space-y-sm">
        <div>
          <label for="minSize" class="mb-xs block text-xs text-text-light">
            Min Size
          </label>
          <input
            type="number"
            id="minSize"
            name="minSize"
            value={currentMinSize}
            min="0"
            step="1"
            placeholder="0"
            class="w-full rounded-md border border-border px-sm py-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
          />
        </div>

        <div>
          <label for="maxSize" class="mb-xs block text-xs text-text-light">
            Max Size
          </label>
          <input
            type="number"
            id="maxSize"
            name="maxSize"
            value={currentMaxSize}
            min="0"
            step="1"
            placeholder="Any"
            class="w-full rounded-md border border-border px-sm py-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
          />
        </div>
      </div>
    </div>

    <!-- Sort By -->
    <div class="border-t border-border pt-lg">
      <h3 class="mb-sm text-sm font-medium text-text">Sort By</h3>
      <select
        id="sort"
        name="sort"
        class="w-full rounded-md border border-border px-sm py-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
      >
        <option value="newest" selected={currentSort === 'newest'}>
          Newest First
        </option>
        <option value="price-asc" selected={currentSort === 'price-asc'}>
          Price: Low to High
        </option>
        <option value="price-desc" selected={currentSort === 'price-desc'}>
          Price: High to Low
        </option>
        <option value="title-asc" selected={currentSort === 'title-asc'}>
          Title: A-Z
        </option>
        <option value="title-desc" selected={currentSort === 'title-desc'}>
          Title: Z-A
        </option>
        <option value="size-asc" selected={currentSort === 'size-asc'}>
          Size: Smallest First
        </option>
        <option value="size-desc" selected={currentSort === 'size-desc'}>
          Size: Largest First
        </option>
      </select>
    </div>

    <!-- Apply Filters Button -->
    <div class="border-t border-border pt-lg">
      <button
        type="submit"
        class="w-full rounded-md bg-primary px-md py-sm font-medium text-white transition-colors hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
      >
        Apply Filters
      </button>
    </div>
  </form>
</aside>

<style>
  /* Custom radio button styling - overrides global min-size */
  .filter-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.25rem 0;
    min-height: auto;
  }

  .filter-radio {
    /* Hide the actual radio but keep it accessible */
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
    min-width: 0 !important;
    min-height: 0 !important;
  }

  .filter-radio-custom {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1rem;
    height: 1rem;
    min-width: 1rem;
    min-height: 1rem;
    border: 2px solid var(--color-border-dark);
    border-radius: 50%;
    margin-right: 0.5rem;
    flex-shrink: 0;
    transition: all 0.15s ease-in-out;
  }

  .filter-radio:checked + .filter-radio-custom {
    border-color: var(--color-primary);
    background-color: var(--color-primary);
  }

  .filter-radio:checked + .filter-radio-custom::after {
    content: '';
    display: block;
    width: 0.375rem;
    height: 0.375rem;
    background-color: white;
    border-radius: 50%;
  }

  .filter-radio:focus-visible + .filter-radio-custom {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .filter-label:hover .filter-radio-custom {
    border-color: var(--color-primary);
  }
</style>

<script>
  // Get form and inputs
  const form = document.getElementById('product-filters') as HTMLFormElement;
  const typeRadios = form?.querySelectorAll('input[name="type"]');
  const sortSelect = form?.querySelector('#sort') as HTMLSelectElement;
  const priceInputs = form?.querySelectorAll('#minPrice, #maxPrice');
  const sizeInputs = form?.querySelectorAll('#minSize, #maxSize');

  // Auto-submit on type change (radio buttons)
  typeRadios?.forEach((radio) => {
    radio.addEventListener('change', () => {
      form?.submit();
    });
  });

  // Auto-submit on sort change
  sortSelect?.addEventListener('change', () => {
    form?.submit();
  });

  // Prevent negative values in price inputs
  priceInputs?.forEach((input) => {
    input.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      if (parseFloat(target.value) < 0) {
        target.value = '0';
      }
    });
  });

  // Prevent negative values in size inputs
  sizeInputs?.forEach((input) => {
    input.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      if (parseFloat(target.value) < 0) {
        target.value = '0';
      }
    });
  });

  // Validate price range (max >= min)
  const validatePriceRange = () => {
    const minPriceInput = form?.querySelector('#minPrice') as HTMLInputElement;
    const maxPriceInput = form?.querySelector('#maxPrice') as HTMLInputElement;
    
    if (minPriceInput && maxPriceInput) {
      const minPrice = parseFloat(minPriceInput.value);
      const maxPrice = parseFloat(maxPriceInput.value);
      
      if (minPrice && maxPrice && maxPrice < minPrice) {
        maxPriceInput.setCustomValidity('Max price must be greater than min price');
      } else {
        maxPriceInput.setCustomValidity('');
      }
    }
  };

  // Validate size range (max >= min)
  const validateSizeRange = () => {
    const minSizeInput = form?.querySelector('#minSize') as HTMLInputElement;
    const maxSizeInput = form?.querySelector('#maxSize') as HTMLInputElement;
    
    if (minSizeInput && maxSizeInput) {
      const minSize = parseFloat(minSizeInput.value);
      const maxSize = parseFloat(maxSizeInput.value);
      
      if (minSize && maxSize && maxSize < minSize) {
        maxSizeInput.setCustomValidity('Max size must be greater than min size');
      } else {
        maxSizeInput.setCustomValidity('');
      }
    }
  };

  // Add validation listeners
  priceInputs?.forEach((input) => {
    input.addEventListener('change', validatePriceRange);
  });

  sizeInputs?.forEach((input) => {
    input.addEventListener('change', validateSizeRange);
  });

  // Validate on form submit
  form?.addEventListener('submit', (e) => {
    validatePriceRange();
    validateSizeRange();
    
    // If validation fails, prevent submit
    if (!form.checkValidity()) {
      e.preventDefault();
      form.reportValidity();
    }
  });
</script>
