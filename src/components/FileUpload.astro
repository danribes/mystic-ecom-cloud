---
/**
 * FileUpload Component
 * 
 * Reusable file upload component with:
 * - Drag and drop support
 * - File type validation
 * - Size validation
 * - Preview for images
 * - Progress indication
 */

interface Props {
  name: string;
  label: string;
  accept?: string;
  maxSize?: number; // in MB
  currentValue?: string;
  required?: boolean;
  helpText?: string;
}

const {
  name,
  label,
  accept = 'image/*',
  maxSize = 10,
  currentValue,
  required = false,
  helpText,
} = Astro.props;

const inputId = `file-upload-${name}`;
---

<div class="file-upload-container" data-name={name}>
  <label for={inputId} class="block text-sm font-medium text-gray-700 mb-2">
    {label}
    {required && <span class="text-red-500 ml-1">*</span>}
  </label>

  {helpText && (
    <p class="text-sm text-gray-500 mb-2">{helpText}</p>
  )}

  <!-- Hidden input for the URL -->
  <input
    type="hidden"
    name={name}
    id={name}
    value={currentValue || ''}
  />

  <!-- Current image preview -->
  {currentValue && (
    <div class="current-file mb-3">
      <img
        src={currentValue}
        alt="Current file"
        class="w-32 h-32 object-cover rounded border border-gray-300"
      />
      <p class="text-xs text-gray-500 mt-1">Current file</p>
    </div>
  )}

  <!-- Upload area -->
  <div
    class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors cursor-pointer bg-gray-50"
    data-upload-area
  >
    <svg
      class="mx-auto h-12 w-12 text-gray-400"
      stroke="currentColor"
      fill="none"
      viewBox="0 0 48 48"
      aria-hidden="true"
    >
      <path
        d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      ></path>
    </svg>
    <div class="mt-4">
      <label
        for={inputId}
        class="relative cursor-pointer rounded-md font-medium text-purple-600 hover:text-purple-500 focus-within:outline-none"
      >
        <span>Upload a file</span>
        <input
          id={inputId}
          type="file"
          class="sr-only"
          accept={accept}
          data-file-input
        />
      </label>
      <p class="text-xs text-gray-500 mt-1">or drag and drop</p>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      {accept} up to {maxSize}MB
    </p>
  </div>

  <!-- Preview area (hidden initially) -->
  <div class="preview-area mt-3 hidden" data-preview-area>
    <img
      src=""
      alt="Preview"
      class="w-32 h-32 object-cover rounded border border-gray-300"
      data-preview-image
    />
    <button
      type="button"
      class="mt-2 text-sm text-red-600 hover:text-red-800"
      data-remove-file
    >
      Remove
    </button>
  </div>

  <!-- Upload progress -->
  <div class="upload-progress mt-3 hidden" data-upload-progress>
    <div class="flex items-center">
      <div class="flex-1 bg-gray-200 rounded-full h-2 overflow-hidden">
        <div
          class="bg-purple-600 h-2 transition-all duration-300"
          style="width: 0%"
          data-progress-bar
        ></div>
      </div>
      <span class="ml-2 text-sm text-gray-600" data-progress-text>0%</span>
    </div>
  </div>

  <!-- Error message -->
  <div class="error-message mt-2 hidden text-sm text-red-600" data-error-message></div>
</div>

<script>
  interface FileUploadElement extends HTMLElement {
    dataset: {
      name: string;
    };
  }

  document.addEventListener('DOMContentLoaded', () => {
    const containers = document.querySelectorAll('.file-upload-container') as NodeListOf<FileUploadElement>;

    containers.forEach((container) => {
      const name = container.dataset.name;
      const uploadArea = container.querySelector('[data-upload-area]') as HTMLElement;
      const fileInput = container.querySelector('[data-file-input]') as HTMLInputElement;
      const hiddenInput = container.querySelector(`#${name}`) as HTMLInputElement;
      const previewArea = container.querySelector('[data-preview-area]') as HTMLElement;
      const previewImage = container.querySelector('[data-preview-image]') as HTMLImageElement;
      const removeButton = container.querySelector('[data-remove-file]') as HTMLButtonElement;
      const progressContainer = container.querySelector('[data-upload-progress]') as HTMLElement;
      const progressBar = container.querySelector('[data-progress-bar]') as HTMLElement;
      const progressText = container.querySelector('[data-progress-text]') as HTMLElement;
      const errorMessage = container.querySelector('[data-error-message]') as HTMLElement;

      if (!uploadArea || !fileInput || !hiddenInput) return;

      // Handle file selection
      fileInput.addEventListener('change', async (e) => {
        const target = e.target as HTMLInputElement;
        const file = target.files?.[0];
        if (file) {
          await handleFile(file);
        }
      });

      // Handle drag and drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('border-purple-500', 'bg-purple-50');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('border-purple-500', 'bg-purple-50');
      });

      uploadArea.addEventListener('drop', async (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-purple-500', 'bg-purple-50');

        const file = e.dataTransfer?.files[0];
        if (file) {
          await handleFile(file);
        }
      });

      // Handle remove button
      if (removeButton) {
        removeButton.addEventListener('click', () => {
          fileInput.value = '';
          hiddenInput.value = '';
          previewArea?.classList.add('hidden');
          errorMessage?.classList.add('hidden');
        });
      }

      // Handle file upload
      async function handleFile(file: File) {
        // Hide error message
        errorMessage.classList.add('hidden');

        // Show preview for images
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            if (previewImage) {
              previewImage.src = e.target?.result as string;
              previewArea?.classList.remove('hidden');
            }
          };
          reader.readAsDataURL(file);
        }

        // Upload file
        try {
          // Show progress
          if (progressContainer) {
            progressContainer.classList.remove('hidden');
            updateProgress(0);
          }

          const formData = new FormData();
          formData.append('file', file);

          const response = await fetch('/api/upload', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer session', // Session-based auth
            },
            body: formData,
          });

          // Simulate progress (since fetch doesn't provide upload progress easily)
          updateProgress(50);

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Upload failed');
          }

          const result = await response.json();
          updateProgress(100);

          // Set the hidden input value to the uploaded file URL
          hiddenInput.value = result.data.url;

          // Hide progress after a delay
          setTimeout(() => {
            if (progressContainer) {
              progressContainer.classList.add('hidden');
            }
          }, 1000);
        } catch (error) {
          console.error('Upload error:', error);
          errorMessage.textContent = error instanceof Error ? error.message : 'Upload failed';
          errorMessage.classList.remove('hidden');
          previewArea?.classList.add('hidden');
          if (progressContainer) {
            progressContainer.classList.add('hidden');
          }
        }
      }

      function updateProgress(percent: number) {
        if (progressBar) {
          progressBar.style.width = `${percent}%`;
        }
        if (progressText) {
          progressText.textContent = `${percent}%`;
        }
      }
    });
  });
</script>
