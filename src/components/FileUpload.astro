---
/**
 * FileUpload Component
 *
 * Reusable file upload component with:
 * - Drag and drop support
 * - File type validation
 * - Size validation
 * - Preview for images and videos
 * - Progress indication
 * - Configurable upload endpoint
 */

interface Props {
  name: string;
  label: string;
  accept?: string;
  maxSize?: number; // in bytes
  currentValue?: string;
  required?: boolean;
  helpText?: string;
  uploadEndpoint?: string; // Configurable endpoint, defaults to /api/admin/upload
  folder?: string; // Optional folder for storage organization
}

const {
  name,
  label,
  accept = 'image/*',
  maxSize = 10 * 1024 * 1024, // 10MB default
  currentValue,
  required = false,
  helpText,
  uploadEndpoint = '/api/admin/upload',
  folder,
} = Astro.props;

const inputId = `file-upload-${name}`;
const maxSizeMB = Math.round(maxSize / (1024 * 1024));
const isVideo = accept.includes('video');
const isImage = accept.includes('image');
---

<div
  class="file-upload-container"
  data-name={name}
  data-endpoint={uploadEndpoint}
  data-folder={folder || ''}
  data-max-size={maxSize}
>
  <label for={inputId} class="block text-sm font-medium text-gray-700 mb-2">
    {label}
    {required && <span class="text-red-500 ml-1">*</span>}
  </label>

  {helpText && (
    <p class="text-sm text-gray-500 mb-2">{helpText}</p>
  )}

  <!-- Hidden input for the URL -->
  <input
    type="hidden"
    name={name}
    id={name}
    value={currentValue || ''}
    data-required={required ? 'true' : 'false'}
  />

  <!-- Current file preview -->
  {currentValue && (
    <div class="current-file mb-3 p-3 bg-gray-50 rounded-lg border border-gray-200" data-current-preview>
      <p class="text-xs text-gray-500 mb-2 font-medium">Current file:</p>
      {isVideo ? (
        <video
          src={currentValue}
          class="w-full max-w-md rounded border border-gray-300"
          controls
          preload="metadata"
        />
      ) : isImage ? (
        <img
          src={currentValue}
          alt="Current file"
          class="w-32 h-32 object-cover rounded border border-gray-300"
        />
      ) : (
        <a
          href={currentValue}
          target="_blank"
          rel="noopener noreferrer"
          class="text-purple-600 hover:text-purple-800 underline text-sm"
        >
          View current file
        </a>
      )}
    </div>
  )}

  <!-- Upload area -->
  <div
    class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-400 transition-colors cursor-pointer bg-gray-50"
    data-upload-area
  >
    <svg
      class="mx-auto h-12 w-12 text-gray-400"
      stroke="currentColor"
      fill="none"
      viewBox="0 0 48 48"
      aria-hidden="true"
    >
      {isVideo ? (
        <path
          d="M15 10v28l22-14L15 10z M8 8h32v32H8V8z"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      ) : (
        <path
          d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      )}
    </svg>
    <div class="mt-4">
      <label
        for={inputId}
        class="relative cursor-pointer rounded-md font-medium text-purple-600 hover:text-purple-500 focus-within:outline-none"
      >
        <span>Upload a file</span>
        <input
          id={inputId}
          type="file"
          class="sr-only"
          accept={accept}
          data-file-input
        />
      </label>
      <p class="text-xs text-gray-500 mt-1">or drag and drop</p>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      {accept.replace(/\*/g, 'files')} up to {maxSizeMB}MB
    </p>
  </div>

  <!-- New file preview area (hidden initially) -->
  <div class="preview-area mt-3 hidden p-3 bg-green-50 rounded-lg border border-green-200" data-preview-area>
    <p class="text-xs text-green-700 mb-2 font-medium">New file uploaded:</p>
    <div class="flex items-start gap-3">
      {isVideo ? (
        <video
          src=""
          class="w-full max-w-md rounded border border-green-300"
          controls
          preload="metadata"
          data-preview-video
        />
      ) : isImage ? (
        <img
          src=""
          alt="Preview"
          class="w-32 h-32 object-cover rounded border border-green-300"
          data-preview-image
        />
      ) : (
        <div class="flex items-center gap-2 text-green-700" data-preview-file>
          <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
          </svg>
          <span class="text-sm" data-preview-filename></span>
        </div>
      )}
      <button
        type="button"
        class="ml-auto px-3 py-1 text-sm text-red-600 bg-red-50 rounded hover:bg-red-100 transition-colors"
        data-remove-file
      >
        Remove
      </button>
    </div>
  </div>

  <!-- Upload progress -->
  <div class="upload-progress mt-3 hidden" data-upload-progress>
    <div class="flex items-center gap-3">
      <div class="flex-1 bg-gray-200 rounded-full h-2 overflow-hidden">
        <div
          class="bg-purple-600 h-2 transition-all duration-300"
          style="width: 0%"
          data-progress-bar
        ></div>
      </div>
      <span class="text-sm text-gray-600 min-w-[3rem]" data-progress-text>0%</span>
    </div>
    <p class="text-xs text-gray-500 mt-1" data-progress-status>Uploading...</p>
  </div>

  <!-- Error message -->
  <div class="error-message mt-2 hidden p-3 bg-red-50 rounded-lg border border-red-200" data-error-message>
    <div class="flex items-center gap-2 text-red-700">
      <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
      </svg>
      <span class="text-sm" data-error-text></span>
    </div>
  </div>

  <!-- Success message -->
  <div class="success-message mt-2 hidden p-3 bg-green-50 rounded-lg border border-green-200" data-success-message>
    <div class="flex items-center gap-2 text-green-700">
      <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
      </svg>
      <span class="text-sm">File uploaded successfully!</span>
    </div>
  </div>
</div>

<script>
  interface FileUploadElement extends HTMLElement {
    dataset: {
      name: string;
      endpoint: string;
      folder: string;
      maxSize: string;
    };
  }

  document.addEventListener('DOMContentLoaded', () => {
    const containers = document.querySelectorAll('.file-upload-container') as NodeListOf<FileUploadElement>;

    containers.forEach((container) => {
      const name = container.dataset.name;
      const endpoint = container.dataset.endpoint || '/api/admin/upload';
      const folder = container.dataset.folder;
      const maxSize = parseInt(container.dataset.maxSize) || 10 * 1024 * 1024;

      const uploadArea = container.querySelector('[data-upload-area]') as HTMLElement;
      const fileInput = container.querySelector('[data-file-input]') as HTMLInputElement;
      const hiddenInput = container.querySelector(`#${name}`) as HTMLInputElement;
      const currentPreview = container.querySelector('[data-current-preview]') as HTMLElement;
      const previewArea = container.querySelector('[data-preview-area]') as HTMLElement;
      const previewImage = container.querySelector('[data-preview-image]') as HTMLImageElement;
      const previewVideo = container.querySelector('[data-preview-video]') as HTMLVideoElement;
      const previewFilename = container.querySelector('[data-preview-filename]') as HTMLElement;
      const removeButton = container.querySelector('[data-remove-file]') as HTMLButtonElement;
      const progressContainer = container.querySelector('[data-upload-progress]') as HTMLElement;
      const progressBar = container.querySelector('[data-progress-bar]') as HTMLElement;
      const progressText = container.querySelector('[data-progress-text]') as HTMLElement;
      const progressStatus = container.querySelector('[data-progress-status]') as HTMLElement;
      const errorMessage = container.querySelector('[data-error-message]') as HTMLElement;
      const errorText = container.querySelector('[data-error-text]') as HTMLElement;
      const successMessage = container.querySelector('[data-success-message]') as HTMLElement;

      if (!uploadArea || !fileInput || !hiddenInput) return;

      // Handle file selection
      fileInput.addEventListener('change', async (e) => {
        const target = e.target as HTMLInputElement;
        const file = target.files?.[0];
        if (file) {
          await handleFile(file);
        }
      });

      // Handle drag and drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('border-purple-500', 'bg-purple-50');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('border-purple-500', 'bg-purple-50');
      });

      uploadArea.addEventListener('drop', async (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-purple-500', 'bg-purple-50');

        const file = e.dataTransfer?.files[0];
        if (file) {
          await handleFile(file);
        }
      });

      // Handle remove button
      if (removeButton) {
        removeButton.addEventListener('click', () => {
          fileInput.value = '';
          hiddenInput.value = '';
          previewArea?.classList.add('hidden');
          successMessage?.classList.add('hidden');
          errorMessage?.classList.add('hidden');
          // Show current preview again if it exists
          if (currentPreview) {
            currentPreview.classList.remove('hidden');
          }
        });
      }

      // Handle file upload
      async function handleFile(file: File) {
        // Hide messages
        errorMessage?.classList.add('hidden');
        successMessage?.classList.add('hidden');

        // Validate file size
        if (file.size > maxSize) {
          const maxSizeMB = Math.round(maxSize / (1024 * 1024));
          showError(`File too large. Maximum size is ${maxSizeMB}MB`);
          return;
        }

        // Show preview for images/videos
        if (file.type.startsWith('image/') && previewImage) {
          const reader = new FileReader();
          reader.onload = (e) => {
            previewImage.src = e.target?.result as string;
            previewArea?.classList.remove('hidden');
            currentPreview?.classList.add('hidden');
          };
          reader.readAsDataURL(file);
        } else if (file.type.startsWith('video/') && previewVideo) {
          const url = URL.createObjectURL(file);
          previewVideo.src = url;
          previewArea?.classList.remove('hidden');
          currentPreview?.classList.add('hidden');
        } else if (previewFilename) {
          previewFilename.textContent = file.name;
          previewArea?.classList.remove('hidden');
          currentPreview?.classList.add('hidden');
        }

        // Upload file
        try {
          // Show progress
          if (progressContainer) {
            progressContainer.classList.remove('hidden');
            updateProgress(0, 'Preparing upload...');
          }

          const formData = new FormData();
          formData.append('file', file);
          if (folder) {
            formData.append('folder', folder);
          }

          updateProgress(10, 'Uploading...');

          const response = await fetch(endpoint, {
            method: 'POST',
            body: formData,
          });

          updateProgress(80, 'Processing...');

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || error.message || 'Upload failed');
          }

          const result = await response.json();
          updateProgress(100, 'Complete!');

          // Set the hidden input value to the uploaded file URL
          const uploadedUrl = result.url || result.data?.url;
          if (uploadedUrl) {
            hiddenInput.value = uploadedUrl;
          } else {
            throw new Error('No URL returned from upload');
          }

          // Hide progress and show success after a delay
          setTimeout(() => {
            if (progressContainer) {
              progressContainer.classList.add('hidden');
            }
            successMessage?.classList.remove('hidden');
          }, 500);
        } catch (error) {
          console.error('Upload error:', error);
          showError(error instanceof Error ? error.message : 'Upload failed');
          previewArea?.classList.add('hidden');
          currentPreview?.classList.remove('hidden');
          if (progressContainer) {
            progressContainer.classList.add('hidden');
          }
        }
      }

      function updateProgress(percent: number, status?: string) {
        if (progressBar) {
          progressBar.style.width = `${percent}%`;
        }
        if (progressText) {
          progressText.textContent = `${percent}%`;
        }
        if (progressStatus && status) {
          progressStatus.textContent = status;
        }
      }

      function showError(message: string) {
        if (errorText) {
          errorText.textContent = message;
        }
        errorMessage?.classList.remove('hidden');
      }
    });
  });
</script>
