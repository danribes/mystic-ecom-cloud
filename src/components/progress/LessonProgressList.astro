---
/**
 * T123: LessonProgressList Component
 * 
 * Displays a list of lessons with progress indicators:
 * - Checkmarks for completed lessons
 * - Time spent on each lesson
 * - Attempt count
 * - Quiz scores
 * - Last accessed date
 * - Current lesson indicator
 */

interface LessonProgress {
  lessonId: string;
  lessonTitle?: string;
  completed: boolean;
  timeSpentSeconds: number;
  attempts: number;
  score: number | null;
  firstStartedAt: Date;
  lastAccessedAt: Date;
  completedAt: Date | null;
}

interface Props {
  lessons: LessonProgress[];
  currentLessonId?: string;
  showTimeSpent?: boolean;
  showAttempts?: boolean;
  showScores?: boolean;
  compact?: boolean;
  className?: string;
}

const {
  lessons = [],
  currentLessonId,
  showTimeSpent = true,
  showAttempts = false,
  showScores = true,
  compact = false,
  className = '',
} = Astro.props;

// Helper function to format time
function formatTime(seconds: number): string {
  if (seconds < 60) return `${seconds}s`;
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes}m`;
  const hours = Math.floor(minutes / 60);
  const remainingMinutes = minutes % 60;
  return `${hours}h ${remainingMinutes}m`;
}

// Helper function to format date
function formatDate(date: Date): string {
  const now = new Date();
  const diff = now.getTime() - new Date(date).getTime();
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  
  if (days === 0) return 'Today';
  if (days === 1) return 'Yesterday';
  if (days < 7) return `${days} days ago`;
  return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
---

<div class={`space-y-2 ${className}`}>
  {lessons.length === 0 ? (
    <div class="text-center py-8 text-gray-500">
      <p>No lesson data available yet</p>
      <p class="text-sm mt-1">Start a lesson to track your progress</p>
    </div>
  ) : (
    lessons.map((lesson, index) => {
      const isCurrent = lesson.lessonId === currentLessonId;
      const borderClass = isCurrent ? 'border-purple-500 bg-purple-50' : 'border-gray-200 bg-white';
      const padding = compact ? 'p-3' : 'p-4';
      
      return (
        <div
          class={`border-2 rounded-lg ${borderClass} ${padding} transition-all hover:shadow-md`}
          data-lesson-id={lesson.lessonId}
        >
          <div class="flex items-start gap-3">
            {/* Completion indicator */}
            <div class="flex-shrink-0 mt-1">
              {lesson.completed ? (
                <div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center">
                  <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
              ) : (
                <div class="w-6 h-6 rounded-full border-2 border-gray-300 bg-white"></div>
              )}
            </div>

            {/* Lesson content */}
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between gap-2">
                {/* Lesson title and number */}
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-gray-500">
                      Lesson {index + 1}
                    </span>
                    {isCurrent && (
                      <span class="px-2 py-0.5 text-xs font-semibold text-purple-700 bg-purple-100 rounded-full">
                        Current
                      </span>
                    )}
                  </div>
                  {lesson.lessonTitle && (
                    <h4 class="text-base font-semibold text-gray-900 mt-0.5">
                      {lesson.lessonTitle}
                    </h4>
                  )}
                </div>

                {/* Score badge (if available) */}
                {showScores && lesson.score !== null && (
                  <div class={`flex-shrink-0 px-3 py-1 rounded-full text-sm font-semibold ${
                    lesson.score >= 70 
                      ? 'bg-green-100 text-green-800' 
                      : 'bg-orange-100 text-orange-800'
                  }`}>
                    {lesson.score}%
                  </div>
                )}
              </div>

              {/* Metadata row */}
              {!compact && (
                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 mt-2 text-sm text-gray-600">
                  {/* Time spent */}
                  {showTimeSpent && lesson.timeSpentSeconds > 0 && (
                    <div class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <span>{formatTime(lesson.timeSpentSeconds)}</span>
                    </div>
                  )}

                  {/* Attempts */}
                  {showAttempts && lesson.attempts > 0 && (
                    <div class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                      </svg>
                      <span>{lesson.attempts} {lesson.attempts === 1 ? 'attempt' : 'attempts'}</span>
                    </div>
                  )}

                  {/* Last accessed */}
                  <div class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-gray-500">
                      {lesson.completed && lesson.completedAt 
                        ? `Completed ${formatDate(lesson.completedAt)}`
                        : `Accessed ${formatDate(lesson.lastAccessedAt)}`
                      }
                    </span>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    })
  )}
</div>

<style>
  /* Smooth hover animation */
  [data-lesson-id] {
    transition: box-shadow 0.2s ease, transform 0.2s ease;
  }
  
  [data-lesson-id]:hover {
    transform: translateY(-2px);
  }
</style>
