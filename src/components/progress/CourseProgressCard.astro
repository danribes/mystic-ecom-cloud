---
/**
 * T123: CourseProgressCard Component
 * 
 * Enhanced course card with detailed progress information:
 * - Course thumbnail and title
 * - Overall progress bar
 * - Lesson completion stats
 * - Time tracking
 * - Resume button pointing to current/next lesson
 * - Quick stats (completed/total lessons, time spent, quiz average)
 */

import ProgressBar from './ProgressBar.astro';

interface Props {
  courseId: string;
  courseTitle: string;
  courseSlug: string;
  courseThumbnailUrl?: string;
  totalLessons: number;
  completedLessons: number;
  progressPercentage: number;
  totalTimeSpent?: number; // in seconds
  averageScore?: number | null;
  lastAccessedAt?: Date;
  nextLessonId?: string;
  nextLessonTitle?: string;
  isCompleted?: boolean;
  className?: string;
}

const {
  courseId,
  courseTitle,
  courseSlug,
  courseThumbnailUrl,
  totalLessons,
  completedLessons,
  progressPercentage,
  totalTimeSpent = 0,
  averageScore = null,
  lastAccessedAt,
  nextLessonId,
  nextLessonTitle,
  isCompleted = false,
  className = '',
} = Astro.props;

// Format time spent
function formatTotalTime(seconds: number): string {
  if (seconds === 0) return 'Not started';
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  
  if (hours === 0) return `${minutes}m`;
  if (minutes === 0) return `${hours}h`;
  return `${hours}h ${minutes}m`;
}

// Format last accessed
function formatLastAccessed(date?: Date): string {
  if (!date) return 'Never';
  const now = new Date();
  const diff = now.getTime() - new Date(date).getTime();
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor(diff / (1000 * 60 * 60));
  
  if (hours < 1) return 'Just now';
  if (hours < 24) return `${hours}h ago`;
  if (days === 1) return 'Yesterday';
  if (days < 7) return `${days}d ago`;
  return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
---

<div 
  class={`bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden ${className}`}
  data-course-id={courseId}
>
  {/* Thumbnail */}
  <div class="relative">
    {courseThumbnailUrl ? (
      <img
        src={courseThumbnailUrl}
        alt={courseTitle}
        class="w-full h-48 object-cover"
      />
    ) : (
      <div class="w-full h-48 bg-gradient-to-br from-primary/10 via-secondary/10 to-info/10 flex items-center justify-center">
        <span class="text-6xl">ðŸ§˜</span>
      </div>
    )}
    
    {/* Completion badge */}
    {isCompleted && (
      <div class="absolute top-3 right-3 px-3 py-1.5 bg-green-500 text-white rounded-full text-sm font-semibold shadow-lg flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        Completed
      </div>
    )}
  </div>

  {/* Content */}
  <div class="p-5">
    {/* Title */}
    <h3 class="text-lg font-bold text-gray-900 mb-3 line-clamp-2 min-h-[3.5rem]">
      {courseTitle}
    </h3>

    {/* Progress bar */}
    <div class="mb-4">
      <ProgressBar
        percentage={progressPercentage}
        label="Course Progress"
        color={isCompleted ? 'green' : 'purple'}
        size="lg"
      />
    </div>

    {/* Stats grid */}
    <div class="grid grid-cols-3 gap-3 mb-4 pb-4 border-b border-gray-200">
      {/* Lessons completed */}
      <div class="text-center">
        <div class="text-2xl font-bold text-gray-900">
          {completedLessons}/{totalLessons}
        </div>
        <div class="text-xs text-gray-500 mt-1">Lessons</div>
      </div>

      {/* Time spent */}
      <div class="text-center">
        <div class="text-2xl font-bold text-gray-900">
          {formatTotalTime(totalTimeSpent)}
        </div>
        <div class="text-xs text-gray-500 mt-1">Time Spent</div>
      </div>

      {/* Average score */}
      <div class="text-center">
        {averageScore !== null ? (
          <>
            <div class={`text-2xl font-bold ${
              averageScore >= 70 ? 'text-green-600' : 'text-orange-600'
            }`}>
              {Math.round(averageScore)}%
            </div>
            <div class="text-xs text-gray-500 mt-1">Avg Score</div>
          </>
        ) : (
          <>
            <div class="text-2xl font-bold text-gray-400">â€”</div>
            <div class="text-xs text-gray-500 mt-1">No Quizzes</div>
          </>
        )}
      </div>
    </div>

    {/* Last accessed info */}
    {lastAccessedAt && (
      <div class="text-sm text-gray-600 mb-4 flex items-center gap-1.5">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Last accessed {formatLastAccessed(lastAccessedAt)}</span>
      </div>
    )}

    {/* Next lesson info (if not completed) */}
    {!isCompleted && nextLessonTitle && (
      <div class="bg-primary/5 border border-primary/20 rounded-lg p-3 mb-4">
        <div class="text-xs font-semibold text-primary uppercase mb-1">
          Next Lesson
        </div>
        <div class="text-sm font-medium text-gray-900 line-clamp-1">
          {nextLessonTitle}
        </div>
      </div>
    )}

    {/* Action buttons */}
    <div class="flex gap-2">
      {/* Continue/Resume button */}
      <a
        href={nextLessonId 
          ? `/courses/${courseSlug}/lessons/${nextLessonId}` 
          : `/courses/${courseSlug}/learn`
        }
        class={`flex-1 px-4 py-2.5 rounded-lg font-medium text-center transition-colors ${
          isCompleted
            ? 'bg-green-600 hover:bg-green-700 text-white'
            : progressPercentage > 0
            ? 'bg-primary hover:bg-primary-dark text-white'
            : 'bg-primary hover:bg-primary-dark text-white'
        }`}
      >
        {isCompleted ? 'Review' : progressPercentage > 0 ? 'Continue' : 'Start'}
      </a>

      {/* View details button */}
      <a
        href={`/dashboard/courses/${courseId}`}
        class="px-4 py-2.5 border-2 border-gray-300 hover:border-primary hover:bg-primary/5 text-gray-700 hover:text-primary-dark rounded-lg font-medium transition-colors"
        title="View detailed progress"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
      </a>
    </div>
  </div>
</div>

<style>
  [data-course-id] {
    transition: transform 0.2s ease, box-shadow 0.3s ease;
  }
  
  [data-course-id]:hover {
    transform: translateY(-4px);
  }
</style>
