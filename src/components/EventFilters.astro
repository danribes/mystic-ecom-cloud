---
/**
 * EventFilters Component
 *
 * Reusable filter sidebar for event catalog with location,
 * date range, time frame, price range, and capacity filters.
 * Supports instant filtering for quick exploration.
 */

interface Props {
  currentCity?: string;
  currentCountry?: string;
  currentStartDate?: string;
  currentEndDate?: string;
  currentTimeFrame?: string;
  currentMinPrice?: string;
  currentMaxPrice?: string;
  currentAvailability?: string;
  cities: string[];
  countries: string[];
}

const {
  currentCity = '',
  currentCountry = '',
  currentStartDate = '',
  currentEndDate = '',
  currentTimeFrame = 'all',
  currentMinPrice = '',
  currentMaxPrice = '',
  currentAvailability = 'all',
  cities = [],
  countries = [],
} = Astro.props;

// Check if any filters are active
const hasActiveFilters =
  currentCity !== '' ||
  currentCountry !== '' ||
  currentStartDate !== '' ||
  currentEndDate !== '' ||
  currentTimeFrame !== 'all' ||
  currentMinPrice !== '' ||
  currentMaxPrice !== '' ||
  currentAvailability !== 'all';
---

<aside class="sticky top-4 w-full rounded-lg border border-border bg-background p-lg">
  <form id="event-filters" action="/events" method="GET" class="space-y-lg">

    <!-- Location Section -->
    <div>
      <h2 class="mb-sm text-lg font-semibold text-text">Location</h2>

      <!-- Country Filter -->
      <div class="mb-sm">
        <label for="country" class="mb-xs block text-sm font-medium text-text-light">
          Country
        </label>
        <select
          id="country"
          name="country"
          class="w-full rounded-md border border-border px-sm py-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
        >
          <option value="">All Countries</option>
          {countries.map((country) => (
            <option value={country} selected={currentCountry === country}>
              {country}
            </option>
          ))}
        </select>
      </div>

      <!-- City Filter -->
      <div>
        <label for="city" class="mb-xs block text-sm font-medium text-text-light">
          City
        </label>
        <select
          id="city"
          name="city"
          class="w-full rounded-md border border-border px-sm py-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
        >
          <option value="">All Cities</option>
          {cities.map((city) => (
            <option value={city} selected={currentCity === city}>
              {city}
            </option>
          ))}
        </select>
      </div>
    </div>

    <!-- Time Frame Filter -->
    <div class="border-t border-border pt-lg">
      <h2 class="mb-sm text-lg font-semibold text-text">Time Frame</h2>

      <div class="space-y-xs">
        <label class="filter-label">
          <input
            type="radio"
            name="timeFrame"
            value="all"
            checked={currentTimeFrame === 'all'}
            class="filter-radio"
          />
          <span class="filter-radio-custom"></span>
          <span class="text-sm text-text-light">All Events</span>
        </label>

        <label class="filter-label">
          <input
            type="radio"
            name="timeFrame"
            value="upcoming"
            checked={currentTimeFrame === 'upcoming'}
            class="filter-radio"
          />
          <span class="filter-radio-custom"></span>
          <span class="text-sm text-text-light">Upcoming Only</span>
        </label>

        <label class="filter-label">
          <input
            type="radio"
            name="timeFrame"
            value="this-week"
            checked={currentTimeFrame === 'this-week'}
            class="filter-radio"
          />
          <span class="filter-radio-custom"></span>
          <span class="text-sm text-text-light">This Week</span>
        </label>

        <label class="filter-label">
          <input
            type="radio"
            name="timeFrame"
            value="this-month"
            checked={currentTimeFrame === 'this-month'}
            class="filter-radio"
          />
          <span class="filter-radio-custom"></span>
          <span class="text-sm text-text-light">This Month</span>
        </label>

        <label class="filter-label">
          <input
            type="radio"
            name="timeFrame"
            value="custom"
            checked={currentTimeFrame === 'custom'}
            class="filter-radio"
          />
          <span class="filter-radio-custom"></span>
          <span class="text-sm text-text-light">Custom Range</span>
        </label>
      </div>
    </div>

    <!-- Custom Date Range (shown when custom timeFrame selected) -->
    <div id="custom-date-range" class:list={[currentTimeFrame === 'custom' ? '' : 'hidden']}>
      <h2 class="mb-sm text-lg font-semibold text-text">Date Range</h2>

      <div class="space-y-sm">
        <div>
          <label for="startDate" class="mb-xs block text-sm font-medium text-text-light">
            From
          </label>
          <input
            type="date"
            id="startDate"
            name="startDate"
            value={currentStartDate}
            class="w-full rounded-md border border-border px-sm py-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
          />
        </div>

        <div>
          <label for="endDate" class="mb-xs block text-sm font-medium text-text-light">
            To
          </label>
          <input
            type="date"
            id="endDate"
            name="endDate"
            value={currentEndDate}
            class="w-full rounded-md border border-border px-sm py-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
          />
        </div>
      </div>
    </div>

    <!-- Price Range Filter -->
    <div class="border-t border-border pt-lg">
      <h2 class="mb-sm text-lg font-semibold text-text">Price Range</h2>

      <div class="space-y-sm">
        <div>
          <label for="minPrice" class="mb-xs block text-sm font-medium text-text-light">
            Minimum ($)
          </label>
          <input
            type="number"
            id="minPrice"
            name="minPrice"
            value={currentMinPrice}
            min="0"
            step="0.01"
            placeholder="0"
            class="w-full rounded-md border border-border px-sm py-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
          />
        </div>

        <div>
          <label for="maxPrice" class="mb-xs block text-sm font-medium text-text-light">
            Maximum ($)
          </label>
          <input
            type="number"
            id="maxPrice"
            name="maxPrice"
            value={currentMaxPrice}
            min="0"
            step="0.01"
            placeholder="No limit"
            class="w-full rounded-md border border-border px-sm py-sm text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
          />
        </div>
      </div>
    </div>

    <!-- Availability Filter -->
    <div class="border-t border-border pt-lg">
      <h2 class="mb-sm text-lg font-semibold text-text">Availability</h2>

      <div class="space-y-xs">
        <label class="filter-label">
          <input
            type="radio"
            name="availability"
            value="all"
            checked={currentAvailability === 'all'}
            class="filter-radio"
          />
          <span class="filter-radio-custom"></span>
          <span class="text-sm text-text-light">All Events</span>
        </label>

        <label class="filter-label">
          <input
            type="radio"
            name="availability"
            value="available"
            checked={currentAvailability === 'available'}
            class="filter-radio"
          />
          <span class="filter-radio-custom"></span>
          <span class="text-sm text-text-light">Spots Available</span>
        </label>

        <label class="filter-label">
          <input
            type="radio"
            name="availability"
            value="limited"
            checked={currentAvailability === 'limited'}
            class="filter-radio"
          />
          <span class="filter-radio-custom"></span>
          <span class="text-sm text-text-light">Limited Spots (&lt; 20%)</span>
        </label>
      </div>
    </div>

    <!-- Apply Filters Button -->
    <button
      type="submit"
      class="w-full rounded-md bg-primary px-md py-sm font-semibold text-white transition-colors duration-200 hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
    >
      Apply Filters
    </button>

    <!-- Clear Filters Link -->
    {hasActiveFilters && (
      <a
        href="/events"
        class="mt-sm block text-center text-sm text-text-light underline hover:text-text"
      >
        Clear all filters
      </a>
    )}
  </form>
</aside>

<style>
  /* Custom radio button styling - overrides global min-size */
  .filter-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.25rem 0;
    min-height: auto;
  }

  .filter-radio {
    /* Hide the actual radio but keep it accessible */
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
    min-width: 0 !important;
    min-height: 0 !important;
  }

  .filter-radio-custom {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1rem;
    height: 1rem;
    min-width: 1rem;
    min-height: 1rem;
    border: 2px solid var(--color-border-dark);
    border-radius: 50%;
    margin-right: 0.5rem;
    flex-shrink: 0;
    transition: all 0.15s ease-in-out;
  }

  .filter-radio:checked + .filter-radio-custom {
    border-color: var(--color-primary);
    background-color: var(--color-primary);
  }

  .filter-radio:checked + .filter-radio-custom::after {
    content: '';
    display: block;
    width: 0.375rem;
    height: 0.375rem;
    background-color: white;
    border-radius: 50%;
  }

  .filter-radio:focus-visible + .filter-radio-custom {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .filter-label:hover .filter-radio-custom {
    border-color: var(--color-primary);
  }
</style>

<script>
  // Auto-submit form when radio buttons or select dropdowns change (instant filtering)
  const form = document.getElementById('event-filters') as HTMLFormElement;
  
  if (form) {
    // Radio buttons: instant filtering
    const radioInputs = form.querySelectorAll('input[type="radio"]');
    radioInputs.forEach((radio) => {
      radio.addEventListener('change', () => {
        form.submit();
      });
    });

    // Select dropdowns: instant filtering
    const selects = form.querySelectorAll('select');
    selects.forEach((select) => {
      select.addEventListener('change', () => {
        form.submit();
      });
    });

    // Show/hide custom date range based on timeFrame selection
    const timeFrameRadios = form.querySelectorAll('input[name="timeFrame"]');
    const customDateRange = document.getElementById('custom-date-range');
    
    timeFrameRadios.forEach((radio) => {
      radio.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        if (customDateRange) {
          if (target.value === 'custom') {
            customDateRange.classList.remove('hidden');
          } else {
            customDateRange.classList.add('hidden');
            // Clear custom date inputs when switching away from custom
            const startDateInput = form.querySelector('#startDate') as HTMLInputElement;
            const endDateInput = form.querySelector('#endDate') as HTMLInputElement;
            if (startDateInput) startDateInput.value = '';
            if (endDateInput) endDateInput.value = '';
          }
        }
      });
    });

    // Validate price inputs (prevent negative values)
    const minPriceInput = form.querySelector('#minPrice') as HTMLInputElement;
    const maxPriceInput = form.querySelector('#maxPrice') as HTMLInputElement;

    [minPriceInput, maxPriceInput].forEach((input) => {
      input?.addEventListener('input', () => {
        if (parseFloat(input.value) < 0) {
          input.value = '0';
        }
      });
    });

    // Validate date range (end date must be after start date)
    const startDateInput = form.querySelector('#startDate') as HTMLInputElement;
    const endDateInput = form.querySelector('#endDate') as HTMLInputElement;

    if (startDateInput && endDateInput) {
      const validateDateRange = () => {
        if (startDateInput.value && endDateInput.value) {
          const start = new Date(startDateInput.value);
          const end = new Date(endDateInput.value);
          
          if (end < start) {
            endDateInput.setCustomValidity('End date must be after start date');
          } else {
            endDateInput.setCustomValidity('');
          }
        }
      };

      startDateInput.addEventListener('change', validateDateRange);
      endDateInput.addEventListener('change', validateDateRange);
    }
  }
</script>
