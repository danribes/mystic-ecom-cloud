---
/**
 * ReviewList Component
 *
 * Displays a paginated list of course reviews with:
 * - User name and avatar
 * - Star rating
 * - Review comment
 * - Date posted
 * - Verified purchase badge
 * - Pagination controls
 *
 * Props:
 * - reviews: Array of ReviewWithDetails objects
 * - currentPage: Current page number
 * - totalPages: Total number of pages
 * - hasMore: Whether there are more pages
 * - courseSlug: Course slug for pagination URLs
 */

interface ReviewWithDetails {
  id: string;
  userId: string;
  courseId: string;
  rating: number;
  comment: string | null;
  isApproved: boolean;
  createdAt: Date | string;
  updatedAt: Date | string;
  userName: string;
  userEmail: string;
  courseTitle: string;
  isVerifiedPurchase: boolean;
}

interface Props {
  reviews: ReviewWithDetails[];
  currentPage?: number;
  totalPages?: number;
  hasMore?: boolean;
  courseSlug: string;
}

const {
  reviews,
  currentPage = 1,
  totalPages = 1,
  hasMore = false,
  courseSlug,
} = Astro.props;

// Helper to format date
const formatDate = (date: Date | string): string => {
  const d = typeof date === 'string' ? new Date(date) : date;
  return d.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Helper to get user initials for avatar
const getInitials = (name: string): string => {
  const parts = name.trim().split(' ');
  if (parts.length >= 2) {
    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
  }
  return name.substring(0, 2).toUpperCase();
};

// Helper to generate avatar color based on name
const getAvatarColor = (name: string): string => {
  const colors = [
    'bg-blue-500',
    'bg-green-500',
    'bg-purple-500',
    'bg-pink-500',
    'bg-indigo-500',
    'bg-red-500',
    'bg-yellow-500',
    'bg-teal-500',
  ];
  const index = name.charCodeAt(0) % colors.length;
  return colors[index];
};

// Compute page numbers for pagination (done in frontmatter to avoid JSX issues with < >)
const computePageNumbers = (): number[] => {
  const pageNumbers = [];
  const maxPages = Math.min(totalPages, 5);

  for (let i = 0; i < maxPages; i++) {
    let pageNum: number;

    if (totalPages <= 5) {
      pageNum = i + 1;
    } else if (currentPage <= 3) {
      pageNum = i + 1;
    } else if (currentPage >= totalPages - 2) {
      pageNum = totalPages - 4 + i;
    } else {
      pageNum = currentPage - 2 + i;
    }

    pageNumbers.push(pageNum);
  }

  return pageNumbers;
};

const pageNumbers = computePageNumbers();
---

<div class="bg-white rounded-lg shadow-md p-6">
  <h3 class="text-xl font-bold text-gray-900 mb-6">Student Reviews</h3>

  {reviews.length === 0 ? (
    <!-- No reviews -->
    <div class="text-center py-8">
      <svg
        class="mx-auto h-12 w-12 text-gray-400 mb-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"
        />
      </svg>
      <p class="text-gray-600 text-lg font-semibold">No reviews yet</p>
      <p class="text-gray-500 text-sm mt-1">Be the first to share your experience!</p>
    </div>
  ) : (
    <!-- Reviews list -->
    <div class="space-y-6">
      {reviews.map((review) => (
        <div class="border-b border-gray-200 last:border-b-0 pb-6 last:pb-0">
          <!-- Review Header -->
          <div class="flex items-start gap-4">
            <!-- User Avatar -->
            <div
              class={`${getAvatarColor(review.userName)} w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0`}
            >
              <span class="text-white font-semibold text-lg">{getInitials(review.userName)}</span>
            </div>

            <!-- Review Content -->
            <div class="flex-1 min-w-0">
              <!-- User Name and Rating -->
              <div class="flex items-center justify-between gap-4 mb-2">
                <div>
                  <h4 class="font-semibold text-gray-900">{review.userName}</h4>
                  {review.isVerifiedPurchase && (
                    <div class="flex items-center gap-1 mt-1">
                      <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path
                          fill-rule="evenodd"
                          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                          clip-rule="evenodd"
                        />
                      </svg>
                      <span class="text-xs text-green-700 font-medium">Verified Purchase</span>
                    </div>
                  )}
                </div>

                <!-- Star Rating -->
                <div class="flex gap-0.5">
                  {Array.from({ length: 5 }, (_, i) => i + 1).map((star) => (
                    <svg
                      class={`w-5 h-5 ${
                        star <= review.rating ? 'text-yellow-400' : 'text-gray-300'
                      }`}
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                  ))}
                </div>
              </div>

              <!-- Review Comment -->
              {review.comment && (
                <p class="text-gray-700 leading-relaxed mb-3">{review.comment}</p>
              )}

              <!-- Review Date -->
              <p class="text-sm text-gray-500">
                Reviewed on {formatDate(review.createdAt)}
              </p>
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="mt-8 flex items-center justify-center gap-2">
        <!-- Previous Button -->
        {currentPage > 1 ? (
          <a
            href={`/courses/${courseSlug}?page=${currentPage - 1}`}
            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
          >
            Previous
          </a>
        ) : (
          <span class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-400 bg-gray-100 cursor-not-allowed">
            Previous
          </span>
        )}

        <!-- Page Numbers -->
        <div class="flex items-center gap-1">
          {pageNumbers.map((pageNum) => (
            <a
              href={`/courses/${courseSlug}?page=${pageNum}`}
              class={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                pageNum === currentPage
                  ? 'bg-blue-600 text-white'
                  : 'text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500'
              }`}
            >
              {pageNum}
            </a>
          ))}
        </div>

        <!-- Next Button -->
        {currentPage < totalPages ? (
          <a
            href={`/courses/${courseSlug}?page=${currentPage + 1}`}
            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
          >
            Next
          </a>
        ) : (
          <span class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-400 bg-gray-100 cursor-not-allowed">
            Next
          </span>
        )}
      </div>
    )}
  )}
</div>
