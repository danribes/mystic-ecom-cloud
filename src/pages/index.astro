---
/**
 * Homepage
 *
 * Displays featured courses, recent offerings, and testimonials from the database.
 */

import BaseLayout from '@/layouts/BaseLayout.astro';
import CourseCard from '@/components/CourseCard.astro';
import type { Course } from '@/types';
import { useTranslations } from '@/lib/pageTranslations';
import { getCourses } from '@/lib/courses';
import { getLocalizedCourses } from '@/lib/coursesI18n';
import { ReviewService } from '@/lib/reviews';
import { initEnv } from '@/lib/env';

export const prerender = false;

// Initialize environment from Cloudflare runtime
const runtime = (Astro.locals as any).runtime;
if (runtime?.env) {
  initEnv(runtime.env);
}

const { t } = useTranslations(Astro.locals);
const locale = Astro.locals.locale || 'en';

// Fetch courses from database
let error: string | null = null;
let featuredCourses: Course[] = [];
let recentCourses: Course[] = [];
let testimonials: any[] = [];

try {
  // Fetch featured courses (marked as featured in the database)
  const featuredResult = await getLocalizedCourses({
    isFeatured: true,
    limit: 3,
    offset: 0,
    locale,
  });
  featuredCourses = featuredResult.items;
} catch (err) {
  console.error('[Homepage] Error fetching featured courses:', err);
  // Try fallback to non-localized
  try {
    const featuredResult = await getCourses({
      isFeatured: true,
      limit: 3,
      offset: 0,
    });
    featuredCourses = featuredResult.items;
  } catch (fallbackErr) {
    console.error('[Homepage] Fallback error fetching featured courses:', fallbackErr);
    error = 'Failed to load featured courses.';
  }
}

try {
  // Fetch recent courses (not featured, sorted by creation date)
  const recentResult = await getLocalizedCourses({
    isFeatured: false,
    limit: 3,
    offset: 0,
    locale,
    sortBy: 'createdAt',
    sortOrder: 'desc',
  });
  recentCourses = recentResult.items;
} catch (err) {
  console.error('[Homepage] Error fetching recent courses:', err);
  // Try fallback to non-localized
  try {
    const recentResult = await getCourses({
      isFeatured: false,
      limit: 3,
      offset: 0,
      sortBy: 'createdAt',
      sortOrder: 'desc',
    });
    recentCourses = recentResult.items;
  } catch (fallbackErr) {
    console.error('[Homepage] Fallback error fetching recent courses:', fallbackErr);
    if (!error) error = 'Failed to load recent courses.';
  }
}

// Fetch approved testimonials/reviews
try {
  const reviewService = new ReviewService();
  const reviewsData = await reviewService.getReviews({
    isApproved: true,
    limit: 4,
    sortBy: 'rating',
    sortOrder: 'DESC',
  });
  testimonials = reviewsData.reviews;
} catch (err) {
  console.error('[Homepage] Error fetching testimonials:', err);
  // Non-critical, continue without testimonials
}
---

<BaseLayout
  title="Quantum Healing Portal - Transform Your Mind, Body & Spirit"
  description="Discover transformative courses in energy healing, manifestation, meditation, and spiritual growth. Join thousands of spiritual seekers on their journey to enlightenment."
  keywords={['spiritual courses', 'energy healing', 'manifestation', 'meditation', 'quantum healing', 'consciousness', 'chakras', 'reiki']}
>
  <!-- Hero Section -->
  <section class="hero-gradient py-3xl text-center text-white">
    <div class="container">
      <div class="mx-auto max-w-[800px]">
        <h1 class="mb-lg text-4xl font-bold leading-tight">
          {t('home.heroTitle')}<br />
          <span class="hero-subtitle">{t('home.heroSubtitle')}</span>
        </h1>
        <p class="mb-2xl text-xl leading-relaxed opacity-95">
          {t('home.heroDescription')}
        </p>
        <div class="flex flex-wrap justify-center gap-md">
          <a href="/courses" class="rounded-md bg-primary px-xl py-md text-lg font-semibold text-white transition-all duration-fast hover:-translate-y-1 hover:bg-primary-dark hover:shadow-lg">
            {t('home.browseAllCourses')}
          </a>
          <a href="/about" class="rounded-md border-2 border-white bg-transparent px-xl py-md text-lg font-semibold text-white transition-all duration-fast hover:-translate-y-1 hover:bg-white/10 hover:shadow-lg">
            {t('home.learnMore')}
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Featured Courses Section -->
  {featuredCourses.length > 0 && (
    <section class="py-3xl">
      <div class="container">
        <div class="mb-2xl text-center">
          <h2 class="mb-md text-3xl font-bold text-text">{t('home.featuredCoursesTitle')}</h2>
          <p class="mx-auto max-w-[600px] text-lg text-text-light">
            {t('home.featuredCoursesDescription')}
          </p>
        </div>

        <div class="mb-2xl grid grid-cols-1 gap-xl sm:grid-cols-2 lg:grid-cols-3">
          {featuredCourses.map((course) => (
            <CourseCard course={course} showDescription={true} />
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Recent Courses Section -->
  {recentCourses.length > 0 && (
    <section class="py-3xl">
      <div class="container">
        <div class="mb-2xl text-center">
          <h2 class="mb-md text-3xl font-bold text-text">{t('home.newArrivalsTitle')}</h2>
          <p class="mx-auto max-w-[600px] text-lg text-text-light">
            {t('home.newArrivalsDescription')}
          </p>
        </div>

        <div class="mb-2xl grid grid-cols-1 gap-xl sm:grid-cols-2 lg:grid-cols-3">
          {recentCourses.map((course) => (
            <CourseCard course={course} />
          ))}
        </div>

        <div class="text-center">
          <a href="/courses" class="inline-block rounded-md bg-primary px-xl py-md font-semibold text-white transition-all duration-fast hover:-translate-y-1 hover:bg-primary-dark hover:shadow-lg">
            {t('home.viewAllCourses')}
          </a>
        </div>
      </div>
    </section>
  )}

  <!-- Testimonials Section -->
  {testimonials.length > 0 && (
    <section class="bg-surface py-3xl">
      <div class="container">
        <div class="mb-2xl text-center">
          <h2 class="mb-md text-3xl font-bold text-text">
            {locale === 'es' ? 'Lo Que Dicen Nuestros Estudiantes' : 'What Our Students Say'}
          </h2>
          <p class="mx-auto max-w-[600px] text-lg text-text-light">
            {locale === 'es'
              ? 'Descubre cómo nuestros cursos han transformado la vida de miles de buscadores espirituales.'
              : 'Discover how our courses have transformed the lives of thousands of spiritual seekers.'}
          </p>
        </div>

        <div class="grid grid-cols-1 gap-xl md:grid-cols-2 lg:grid-cols-4">
          {testimonials.map((review) => (
            <div class="flex flex-col rounded-xl bg-background p-lg shadow-md">
              <div class="mb-md flex items-center gap-xs">
                {[...Array(5)].map((_, i) => (
                  <span class={i < review.rating ? 'text-amber-400' : 'text-gray-300'}>
                    ★
                  </span>
                ))}
              </div>
              <p class="mb-lg flex-1 text-text-light italic">
                "{review.comment}"
              </p>
              <div class="flex items-center gap-md border-t border-border pt-md">
                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary text-white font-bold">
                  {review.user_name ? review.user_name.charAt(0).toUpperCase() : 'U'}
                </div>
                <div>
                  <div class="font-semibold text-text">{review.user_name || 'Student'}</div>
                  {review.course_title && (
                    <div class="text-sm text-text-light">{review.course_title}</div>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- CTA Section -->
  <section class="cta-gradient py-3xl text-center">
    <div class="container">
      <div class="mx-auto max-w-[700px]">
        <h2 class="mb-md text-3xl font-bold text-text">{t('home.ctaTitle')}</h2>
        <p class="mb-xl text-lg text-text-light">
          {t('home.ctaDescription')}
        </p>
        <a href="/courses" class="inline-block rounded-md bg-secondary px-xl py-md text-lg font-semibold text-white transition-all duration-fast hover:-translate-y-1 hover:bg-secondary-dark hover:shadow-lg">
          {t('home.startLearningToday')}
        </a>
      </div>
    </div>
  </section>
</BaseLayout>

