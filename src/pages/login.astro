---
/**
 * User Login Page
 * 
 * Allows users to sign in to their account.
 * Validates credentials and creates session.
 */

import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCSRFInput } from '@/lib/csrf';

export const prerender = false; // Enable SSR for form handling

// Check if already logged in
import { getSessionFromRequest } from '@/lib/auth/session';
const session = await getSessionFromRequest(Astro.cookies);
if (session) {
  return Astro.redirect('/dashboard');
}

// Get redirect parameter (where to go after login)
const redirect = Astro.url.searchParams.get('redirect') || '/dashboard';

// Get error/success messages from URL
const error = Astro.url.searchParams.get('error');
const success = Astro.url.searchParams.get('success');
const verify = Astro.url.searchParams.get('verify');
---

<BaseLayout 
  title="Sign In - Spirituality Platform"
  description="Access your account and continue your spiritual journey"
>
  <div class="min-h-screen flex items-center justify-center px-4 py-12 bg-gradient-to-br from-purple-50 to-indigo-50">
    <div class="max-w-md w-full">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">
          Welcome Back üôè
        </h1>
        <p class="text-gray-600">
          Sign in to access your courses and continue learning
        </p>
      </div>

      <!-- Login Card -->
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <!-- Success Message -->
        {success && (
          <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-sm text-green-800 flex items-center">
              <span class="mr-2">‚úÖ</span>
              {success === 'registered' && 'Account created! Please check your email to verify your account.'}
              {success === 'logout' && 'You have been logged out successfully.'}
              {success === 'email_verified' && 'Email verified! You can now sign in.'}
              {success === 'already_verified' && 'Your email is already verified. You can sign in.'}
              {success === 'verification_sent' && 'Verification email sent! Please check your inbox.'}
            </p>
          </div>
        )}

        <!-- Verification Notice -->
        {verify === 'check_email' && (
          <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-sm text-blue-800 flex items-center mb-2">
              <span class="mr-2">üìß</span>
              Please check your email to verify your account before signing in.
            </p>
            <form method="POST" action="/api/auth/resend-verification" class="mt-3">
              <input type="email" name="email" placeholder="Enter your email" required
                class="w-full px-3 py-2 border border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-2" />
              <button type="submit" class="text-sm text-blue-700 hover:text-blue-800 font-medium underline">
                Resend verification email
              </button>
            </form>
          </div>
        )}

        <!-- Error Message -->
        {error && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-sm text-red-800 flex items-center">
              <span class="mr-2">‚ö†Ô∏è</span>
              {error === 'invalid_credentials' && 'Invalid email or password. Please try again.'}
              {error === 'unverified_email' && 'Please verify your email before signing in. Check your inbox for the verification link.'}
              {error === 'validation_error' && 'Please enter a valid email and password.'}
              {error === 'server_error' && 'Something went wrong. Please try again later.'}
              {error === 'auth_required' && 'Please sign in to access that page.'}
              {error === 'admin_auth_required' && 'Admin access required. Please sign in with an admin account.'}
              {error === 'admin_access_denied' && 'You do not have permission to access that page.'}
              {error === 'invalid_token' && 'Invalid or expired verification link. Please request a new one.'}
              {error === 'token_expired' && 'Verification link has expired. Please request a new one.'}
              {error === 'verification_failed' && 'Email verification failed. Please try again.'}
            </p>
            {(error === 'unverified_email' || error === 'invalid_token' || error === 'token_expired') && (
              <form method="POST" action="/api/auth/resend-verification" class="mt-3">
                <input type="email" name="email" placeholder="Enter your email" required
                  class="w-full px-3 py-2 border border-red-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 mb-2" />
                <button type="submit" class="text-sm text-red-700 hover:text-red-800 font-medium underline">
                  Resend verification email
                </button>
              </form>
            )}
          </div>
        )}

        <!-- Login Form -->
        <form method="POST" action="/api/auth/login" class="space-y-6">
          <!-- CSRF Token -->
          <Fragment set:html={getCSRFInput(Astro.cookies)} />
          <!-- Hidden redirect field -->
          <input type="hidden" name="redirect" value={redirect} />

          <!-- Email Field -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              Email Address
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="you@example.com"
              autocomplete="email"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
            />
          </div>

          <!-- Password Field -->
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
              Password
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              placeholder="Enter your password"
              autocomplete="current-password"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
            />
          </div>

          <!-- Remember Me & Forgot Password -->
          <div class="flex items-center justify-between">
            <label class="remember-me-label flex items-center cursor-pointer">
              <input
                type="checkbox"
                id="remember"
                name="remember"
                class="remember-checkbox"
              />
              <span class="remember-checkbox-custom"></span>
              <span class="ml-2 text-sm text-gray-600">
                Remember me
              </span>
            </label>
            <a
              href="/forgot-password"
              class="text-sm text-purple-600 hover:text-purple-700"
            >
              Forgot password?
            </a>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all duration-200 transform hover:scale-[1.02]"
          >
            Sign In
          </button>
        </form>

        <!-- Divider -->
        <div class="mt-6 flex items-center">
          <div class="flex-1 border-t border-gray-300"></div>
          <span class="px-4 text-sm text-gray-500">New to our platform?</span>
          <div class="flex-1 border-t border-gray-300"></div>
        </div>

        <!-- Register Link -->
        <div class="mt-6 text-center">
          <a
            href={`/register?redirect=${encodeURIComponent(redirect)}`}
            class="text-purple-600 hover:text-purple-700 font-medium text-sm"
          >
            Create a new account ‚Üí
          </a>
        </div>
      </div>

      <!-- Back to Home -->
      <div class="mt-6 text-center">
        <a
          href="/"
          class="text-sm text-gray-600 hover:text-gray-900"
        >
          ‚Üê Back to Home
        </a>
      </div>
    </div>
  </div>

  <style>
    /* Custom checkbox styling to override WCAG min-size rules */
    .remember-checkbox {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
      min-width: 0 !important;
      min-height: 0 !important;
    }

    .remember-checkbox-custom {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      min-width: 1rem;
      min-height: 1rem;
      border: 2px solid #d1d5db;
      border-radius: 0.25rem;
      background-color: white;
      transition: all 0.15s ease-in-out;
      position: relative;
      flex-shrink: 0;
    }

    .remember-checkbox:checked + .remember-checkbox-custom {
      background-color: #9333ea;
      border-color: #9333ea;
    }

    .remember-checkbox:checked + .remember-checkbox-custom::after {
      content: '';
      position: absolute;
      left: 4px;
      top: 1px;
      width: 5px;
      height: 9px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .remember-checkbox:focus + .remember-checkbox-custom {
      box-shadow: 0 0 0 2px rgba(147, 51, 234, 0.3);
    }

    .remember-me-label:hover .remember-checkbox-custom {
      border-color: #9333ea;
    }
  </style>

  <!-- Client-side Form Validation -->
  <script>
    const form = document.querySelector('form');
    const email = document.getElementById('email') as HTMLInputElement;
    const password = document.getElementById('password') as HTMLInputElement;

    form?.addEventListener('submit', (e) => {
      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email.value)) {
        e.preventDefault();
        alert('Please enter a valid email address.');
        email.focus();
        return false;
      }

      // Password length check
      if (password.value.length < 8) {
        e.preventDefault();
        alert('Password must be at least 8 characters long.');
        password.focus();
        return false;
      }
    });
  </script>
</BaseLayout>
