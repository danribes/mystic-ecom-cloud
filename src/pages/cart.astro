---
/**
 * Shopping Cart Page
 *
 * Displays cart items with quantities, prices, and totals.
 * Allows quantity updates, item removal, and proceeding to checkout.
 */

import BaseLayout from '@/layouts/BaseLayout.astro';
import CartItem from '@/components/CartItem.astro';
import type { Cart, CartItem as CartItemType } from '@/types';
import { useTranslations } from '@/lib/pageTranslations';

const { locale, t } = useTranslations(Astro.locals);

// For now, use mock data from sessionStorage (until cart API T042-T044 is implemented)
// In production, this would fetch from: GET /api/cart
let cart: Cart | null = null;
let error: string | null = null;

// Mock cart data - in production this will come from the API
// For now, we'll load it client-side from sessionStorage
const emptyCart: Cart = {
  userId: 'guest',
  items: [],
  subtotal: 0,
  tax: 0,
  total: 0,
  itemCount: 0,
  updatedAt: new Date(),
};

// Helper functions
const formatPrice = (cents: number): string => {
  return `$${(cents / 100).toFixed(2)}`;
};

const TAX_RATE = 0.08; // 8% tax
---

<BaseLayout
  title={t('cart.title')}
  description={t('cart.title')}
>
  <div class="cart-page" data-locale={locale} data-confirm-remove={t('cart.confirmRemove')} data-confirm-clear={t('cart.confirmClear')} data-remove-text={t('cart.remove')} data-each-text={t('cart.each')}>
    <div class="mx-auto max-w-[1200px] px-lg py-xl md:px-lg">
      <div class="mb-2xl flex flex-col items-start justify-between gap-md md:flex-row md:items-center">
        <h1 class="m-0 text-4xl font-bold text-text md:text-4xl">{t('cart.title')}</h1>
        <a href="/courses" class="font-medium text-primary no-underline transition-colors duration-fast hover:text-primary-dark">‚Üê {t('cart.continueShopping')}</a>
      </div>

      <!-- Empty Cart State -->
      <div class="hidden min-h-[400px] items-center justify-center" id="empty-cart-state">
        <div class="max-w-[500px] text-center">
          <span class="mb-lg block text-[5rem]">üõí</span>
          <h2 class="mb-md text-3xl text-text">{t('cart.emptyCart')}</h2>
          <p class="mb-xl leading-relaxed text-text-light">{t('cart.emptyCartMessage')}</p>
          <a href="/courses" class="inline-block rounded-md bg-primary px-2xl py-md text-white no-underline transition-all duration-fast hover:-translate-y-0.5 hover:bg-primary-dark hover:shadow-lg">{t('courses.browseCourses')}</a>
        </div>
      </div>

      <!-- Cart Content -->
      <div class="cart-content" id="cart-content-area">
        <div class="grid grid-cols-1 items-start gap-2xl lg:grid-cols-[1fr_400px]">
          <!-- Cart Items -->
          <div class="min-w-0">
            <h2 class="mb-xl flex items-center justify-between text-2xl font-semibold text-text">
              <span>{t('cart.cartItems')}</span>
              <span class="text-base font-normal text-text-light" id="cart-item-count" data-items-text={t('cart.items')} data-item-text={t('cart.item')}>0 {t('cart.items')}</span>
            </h2>

            <div class="flex flex-col gap-lg" id="cart-items-list">
              <!-- Cart items will be loaded dynamically via JavaScript -->
            </div>

            <!-- Loading State -->
            <div class="flex flex-col items-center gap-md p-3xl text-text-light" id="loading-state">
              <div class="h-10 w-10 animate-spin rounded-full border-4 border-border border-t-primary"></div>
              <p>{t('cart.loadingCart')}</p>
            </div>
          </div>

          <!-- Order Summary -->
          <aside class="sticky top-lg">
            <div class="mb-lg rounded-lg border border-border bg-white p-xl">
              <h2 class="mb-lg text-xl font-semibold text-text">{t('cart.orderSummary')}</h2>

              <div class="mb-md flex items-center justify-between text-text">
                <span class="text-text-light">{t('cart.subtotal')}:</span>
                <span class="font-medium" id="summary-subtotal">$0.00</span>
              </div>

              <div class="mb-md flex items-center justify-between text-text">
                <span class="text-text-light">{t('cart.tax')} (8%):</span>
                <span class="font-medium" id="summary-tax">$0.00</span>
              </div>

              <div class="my-lg h-px bg-border"></div>

              <div class="mb-xl flex items-center justify-between text-xl font-bold text-text">
                <span>{t('cart.total')}:</span>
                <span class="text-primary" id="summary-total">$0.00</span>
              </div>

              <button class="mb-0 w-full cursor-pointer rounded-md border-none bg-primary px-xl py-md text-lg font-semibold text-white transition-all duration-fast hover:-translate-y-0.5 hover:bg-primary-dark hover:shadow-lg disabled:cursor-not-allowed disabled:opacity-50" id="btn-checkout">
                {t('cart.proceedToCheckout')}
              </button>

              <div class="mt-lg flex items-center justify-center gap-sm text-sm text-text-light">
                <span class="text-base">üîí</span>
                <span>{t('cart.secureCheckout')}</span>
              </div>
            </div>

            <!-- Cart Actions -->
            <div class="rounded-lg border border-border bg-surface p-lg">
              <button class="w-full cursor-pointer rounded-md border border-border bg-transparent px-lg py-sm text-base font-medium text-error transition-all duration-fast hover:border-error hover:bg-error-light" id="btn-clear-cart">
                {t('cart.clearCart')}
              </button>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>


<script>
  /**
   * Shopping Cart Page Functionality
   * Loads cart from sessionStorage and handles cart operations
   */

  import type { Cart, CartItem } from '@/types';

  const TAX_RATE = 0.08;

  // Format price
  function formatPrice(cents: number): string {
    return `$${(cents / 100).toFixed(2)}`;
  }

  // Get cart from sessionStorage
  function getCart(): Cart {
    const cartItems = JSON.parse(sessionStorage.getItem('cartItems') || '[]');
    const subtotal = cartItems.reduce((sum: number, item: CartItem) => sum + item.price * item.quantity, 0);
    const tax = Math.round(subtotal * TAX_RATE);
    const total = subtotal + tax;
    const itemCount = cartItems.reduce((sum: number, item: CartItem) => sum + item.quantity, 0);

    return {
      userId: 'guest',
      items: cartItems,
      subtotal,
      tax,
      total,
      itemCount,
      updatedAt: new Date(),
    };
  }

  // Save cart to sessionStorage
  function saveCart(cart: Cart): void {
    sessionStorage.setItem('cartItems', JSON.stringify(cart.items));
    sessionStorage.setItem('cartItemCount', cart.itemCount.toString());
  }

  // Render cart items
  function renderCartItems(cart: Cart): void {
    const cartItemsList = document.getElementById('cart-items-list');
    const cartPage = document.querySelector('.cart-page') as HTMLElement;
    if (!cartItemsList) return;

    if (cart.items.length === 0) {
      showEmptyCart();
      return;
    }

    cartItemsList.innerHTML = '';

    // Get translated strings from data attributes
    const removeText = cartPage?.dataset.removeText || 'Remove';
    const eachText = cartPage?.dataset.eachText || 'each';

    cart.items.forEach((item) => {
      const itemElement = document.createElement('div');
      itemElement.className = 'cart-item';
      itemElement.dataset.itemId = item.itemId;
      itemElement.dataset.itemType = item.itemType;

      const imageSrc = item.itemImageUrl || 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=200';
      const itemTotal = item.price * item.quantity;
      const itemTypeLabel = item.itemType === 'course' ? 'Course' : item.itemType === 'event' ? 'Event' : 'Digital Product';

      itemElement.innerHTML = `
        <div class="item-image">
          <img src="${imageSrc}" alt="${item.itemTitle}" />
          <span class="item-type-badge">${itemTypeLabel}</span>
        </div>

        <div class="item-details">
          <h3 class="item-title">
            <a href="/${item.itemType === 'course' ? 'courses' : 'products'}/${item.itemSlug || item.itemId}">
              ${item.itemTitle}
            </a>
          </h3>
          <p class="item-price">${formatPrice(item.price)} ${eachText}</p>
        </div>

        <div class="item-actions">
          <div class="quantity-controls">
            <button class="btn-quantity btn-decrease" aria-label="Decrease quantity" data-action="decrease">‚àí</button>
            <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="10" aria-label="Quantity" />
            <button class="btn-quantity btn-increase" aria-label="Increase quantity" data-action="increase">+</button>
          </div>

          <div class="item-total">
            <span class="total-label">Total:</span>
            <span class="total-price">${formatPrice(itemTotal)}</span>
          </div>

          <button class="btn-remove" aria-label="${removeText}" data-action="remove">
            <span class="remove-icon">üóëÔ∏è</span>
            <span class="remove-text">${removeText}</span>
          </button>
        </div>
      `;

      // Add styles dynamically (CartItem.astro styles)
      addCartItemStyles();

      cartItemsList.appendChild(itemElement);
    });

    // Update item count
    const itemCountEl = document.getElementById('cart-item-count') as HTMLElement;
    if (itemCountEl) {
      const itemsText = itemCountEl.dataset.itemsText || 'items';
      const itemText = itemCountEl.dataset.itemText || 'item';
      itemCountEl.textContent = `${cart.itemCount} ${cart.itemCount === 1 ? itemText : itemsText}`;
    }

    // Attach event listeners to new items
    attachCartItemListeners();
  }

  // Add CartItem styles
  function addCartItemStyles(): void {
    if (document.getElementById('cart-item-styles')) return;

    const style = document.createElement('style');
    style.id = 'cart-item-styles';
    style.textContent = `
      .cart-item {
        display: grid;
        grid-template-columns: 150px 1fr auto;
        gap: var(--spacing-lg);
        padding: var(--spacing-lg);
        background: white;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        transition: box-shadow var(--transition-fast);
      }
      .cart-item:hover {
        box-shadow: var(--shadow-md);
      }
      .item-image {
        position: relative;
        width: 150px;
        height: 100px;
        border-radius: var(--radius-md);
        overflow: hidden;
      }
      .item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .item-type-badge {
        position: absolute;
        top: var(--spacing-xs);
        left: var(--spacing-xs);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
      }
      .item-details {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }
      .item-title {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        margin: 0;
      }
      .item-title a {
        color: var(--color-text);
        text-decoration: none;
        transition: color var(--transition-fast);
      }
      .item-title a:hover {
        color: var(--color-primary);
      }
      .item-price {
        color: var(--color-text-light);
        font-size: var(--font-size-sm);
        margin: 0;
      }
      .item-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: var(--spacing-md);
      }
      .quantity-controls {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        overflow: hidden;
      }
      .btn-quantity {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--color-surface);
        color: var(--color-text);
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        transition: background var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .btn-quantity:hover:not(:disabled) {
        background: var(--color-surface-dark);
      }
      .quantity-input {
        width: 50px;
        height: 32px;
        border: none;
        border-left: 1px solid var(--color-border);
        border-right: 1px solid var(--color-border);
        text-align: center;
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-medium);
        background: white;
      }
      .item-total {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: var(--spacing-xs);
      }
      .total-label {
        font-size: var(--font-size-sm);
        color: var(--color-text-light);
      }
      .total-price {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-primary);
      }
      .btn-remove {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        background: white;
        color: var(--color-error);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        cursor: pointer;
        transition: all var(--transition-fast);
      }
      .btn-remove:hover {
        background: var(--color-error-light);
        border-color: var(--color-error);
      }
      @media (max-width: 768px) {
        .cart-item {
          grid-template-columns: 100px 1fr;
        }
        .item-image {
          width: 100px;
          height: 75px;
        }
        .item-actions {
          grid-column: 1 / -1;
          flex-direction: row;
          justify-content: space-between;
        }
      }
    `;
    document.head.appendChild(style);
  }

  // Update order summary
  function updateOrderSummary(cart: Cart): void {
    const subtotalEl = document.getElementById('summary-subtotal');
    const taxEl = document.getElementById('summary-tax');
    const totalEl = document.getElementById('summary-total');

    if (subtotalEl) subtotalEl.textContent = formatPrice(cart.subtotal);
    if (taxEl) taxEl.textContent = formatPrice(cart.tax);
    if (totalEl) totalEl.textContent = formatPrice(cart.total);
  }

  // Show empty cart state
  function showEmptyCart(): void {
    const emptyState = document.getElementById('empty-cart-state');
    const contentArea = document.getElementById('cart-content-area');

    if (emptyState) emptyState.style.display = 'flex';
    if (contentArea) contentArea.style.display = 'none';
  }

  // Show cart content
  function showCartContent(): void {
    const emptyState = document.getElementById('empty-cart-state');
    const contentArea = document.getElementById('cart-content-area');
    const loadingState = document.getElementById('loading-state');

    if (emptyState) emptyState.style.display = 'none';
    if (contentArea) contentArea.style.display = 'block';
    if (loadingState) loadingState.style.display = 'none';
  }

  // Handle quantity change
  function handleQuantityChange(itemId: string, itemType: string, quantity: number): void {
    const cart = getCart();
    const item = cart.items.find(i => i.itemId === itemId && i.itemType === itemType);
    
    if (item) {
      item.quantity = quantity;
      saveCart(cart);
      loadCart();
    }
  }

  // Handle remove item
  function handleRemoveItem(itemId: string, itemType: string): void {
    const cartPage = document.querySelector('.cart-page') as HTMLElement;
    const confirmMsg = cartPage?.dataset.confirmRemove || 'Remove this item from your cart?';
    if (!confirm(confirmMsg)) return;

    const cart = getCart();
    cart.items = cart.items.filter(i => !(i.itemId === itemId && i.itemType === itemType));
    saveCart(cart);
    loadCart();
  }

  // Attach event listeners to cart items
  function attachCartItemListeners(): void {
    const cartItems = document.querySelectorAll('.cart-item');

    cartItems.forEach(item => {
      const htmlItem = item as HTMLElement;
      const itemId = htmlItem.dataset.itemId!;
      const itemType = htmlItem.dataset.itemType!;

      // Quantity buttons
      const btnDecrease = htmlItem.querySelector('.btn-decrease');
      const btnIncrease = htmlItem.querySelector('.btn-increase');
      const quantityInput = htmlItem.querySelector('.quantity-input') as HTMLInputElement;

      if (btnDecrease) {
        btnDecrease.addEventListener('click', () => {
          const newQty = Math.max(1, parseInt(quantityInput.value) - 1);
          handleQuantityChange(itemId, itemType, newQty);
        });
      }

      if (btnIncrease) {
        btnIncrease.addEventListener('click', () => {
          const newQty = Math.min(10, parseInt(quantityInput.value) + 1);
          handleQuantityChange(itemId, itemType, newQty);
        });
      }

      if (quantityInput) {
        quantityInput.addEventListener('change', () => {
          const newQty = Math.max(1, Math.min(10, parseInt(quantityInput.value)));
          handleQuantityChange(itemId, itemType, newQty);
        });
      }

      // Remove button
      const btnRemove = htmlItem.querySelector('.btn-remove');
      if (btnRemove) {
        btnRemove.addEventListener('click', () => {
          handleRemoveItem(itemId, itemType);
        });
      }
    });
  }

  // Load cart
  function loadCart(): void {
    const cart = getCart();

    if (cart.items.length === 0) {
      showEmptyCart();
    } else {
      showCartContent();
      renderCartItems(cart);
      updateOrderSummary(cart);
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    // Load cart initially
    setTimeout(loadCart, 100);

    // Checkout button
    const btnCheckout = document.getElementById('btn-checkout');
    if (btnCheckout) {
      btnCheckout.addEventListener('click', () => {
        const cart = getCart();
        if (cart.items.length === 0) {
          alert('Your cart is empty');
          return;
        }

        // TODO: Redirect to checkout page when T045 is implemented
        alert('Redirecting to checkout... (Checkout page will be implemented in T045)');
        // window.location.href = '/checkout';
      });
    }

    // Clear cart button
    const btnClearCart = document.getElementById('btn-clear-cart');
    if (btnClearCart) {
      btnClearCart.addEventListener('click', () => {
        const cartPage = document.querySelector('.cart-page') as HTMLElement;
        const confirmMsg = cartPage?.dataset.confirmClear || 'Are you sure you want to clear your cart?';
        if (!confirm(confirmMsg)) return;

        sessionStorage.removeItem('cartItems');
        sessionStorage.setItem('cartItemCount', '0');
        loadCart();
      });
    }
  });
</script>
