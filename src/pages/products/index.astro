---
/**
 * Digital Products Catalog Page
 * Displays all available digital products with advanced filtering
 */

import BaseLayout from '@/layouts/BaseLayout.astro';
import ProductCard from '@/components/ProductCard.astro';
import ProductFilters from '@/components/ProductFilters.astro';
import { getProducts } from '@/lib/products';
import { useTranslations } from '@/lib/pageTranslations';

const { t } = useTranslations(Astro.locals);

// Get query parameters for filtering
const url = new URL(Astro.request.url);
const searchParams = url.searchParams;

const type = searchParams.get('type') || 'all';
const search = searchParams.get('search') || '';
const minPrice = searchParams.get('minPrice') || '';
const maxPrice = searchParams.get('maxPrice') || '';
const minSize = searchParams.get('minSize') || '';
const maxSize = searchParams.get('maxSize') || '';
const sortBy = searchParams.get('sort') || 'newest';
const page = parseInt(searchParams.get('page') || '1');

// Pagination settings
const limit = 12;
const offset = (page - 1) * limit;

// Build filters object
const filters: any = {
  type: type !== 'all' ? (type as 'pdf' | 'audio' | 'video' | 'ebook') : undefined,
  search: search || undefined,
  minPrice: minPrice ? parseFloat(minPrice) : undefined,
  maxPrice: maxPrice ? parseFloat(maxPrice) : undefined,
  minSize: minSize ? parseFloat(minSize) : undefined,
  maxSize: maxSize ? parseFloat(maxSize) : undefined,
  sortBy: sortBy as any,
  limit: limit + 1, // Fetch one extra to check if there are more pages
  offset,
};

// Fetch products with filters
let products: any[] = [];
let error = '';

try {
  const allProducts = await getProducts(filters);
  const hasMore = allProducts.length > limit;
  products = hasMore ? allProducts.slice(0, limit) : allProducts;
} catch (e) {
  error = 'Failed to load products. Please try again later.';
  products = [];
}

// Calculate pagination
const totalPages = Math.ceil((products.length === limit ? (page * limit) + 1 : page * limit) / limit);
const hasPrevPage = page > 1;
const hasNextPage = products.length === limit;

// Helper function to build page URLs with preserved filters
function buildPageUrl(pageNum: number): string {
  const params = new URLSearchParams();
  params.set('page', pageNum.toString());
  
  if (type !== 'all') params.set('type', type);
  if (search) params.set('search', search);
  if (minPrice) params.set('minPrice', minPrice);
  if (maxPrice) params.set('maxPrice', maxPrice);
  if (minSize) params.set('minSize', minSize);
  if (maxSize) params.set('maxSize', maxSize);
  if (sortBy !== 'newest') params.set('sort', sortBy);
  
  return `/products?${params.toString()}`;
}

// Helper function to build URL for clearing specific filter
function buildClearFilterUrl(filterName: string): string {
  const params = new URLSearchParams();
  params.set('page', '1'); // Reset to first page
  
  if (filterName !== 'type' && type !== 'all') params.set('type', type);
  if (filterName !== 'search' && search) params.set('search', search);
  if (filterName !== 'minPrice' && minPrice) params.set('minPrice', minPrice);
  if (filterName !== 'maxPrice' && maxPrice) params.set('maxPrice', maxPrice);
  if (filterName !== 'minSize' && minSize) params.set('minSize', minSize);
  if (filterName !== 'maxSize' && maxSize) params.set('maxSize', maxSize);
  if (sortBy !== 'newest') params.set('sort', sortBy);
  
  return `/products?${params.toString()}`;
}

// Check for active filters
const activeFilterCount = [
  type !== 'all',
  search !== '',
  minPrice !== '',
  maxPrice !== '',
  minSize !== '',
  maxSize !== '',
].filter(Boolean).length;

const hasActiveFilters = activeFilterCount > 0;
---

<BaseLayout
  title="Digital Products - Spiritual Resources"
  description="Explore our collection of spiritual guides, meditation audio, and transformative video content"
  keywords="digital products, spiritual guides, meditation audio, video content, PDF, ebooks"
>
  <main class="min-h-screen bg-surface py-2xl">
    <div class="container mx-auto px-md">
      <!-- Header -->
      <div class="mb-2xl">
        <h1 class="mb-sm text-3xl font-bold text-text md:text-4xl">
          {t('products.digitalProducts')}
        </h1>
        <p class="text-lg text-text-light">
          {t('products.browseDescription')}
          {activeFilterCount > 0 && (
            <span class="text-text-lighter">
              {' '}({activeFilterCount === 1 ? t('products.filterApplied', { count: activeFilterCount }) : t('products.filtersApplied', { count: activeFilterCount })})
            </span>
          )}
        </p>
      </div>

      <!-- Error Message -->
      {error && (
        <div class="mb-lg rounded-lg border border-error/20 bg-error-light p-md">
          <p class="text-error">{error}</p>
        </div>
      )}

      <!-- Search Bar (Top of Page) -->
      {!error && (
        <div class="mb-lg">
          <form method="GET" action="/products" class="max-w-2xl">
            <div class="flex gap-sm">
              <input
                type="text"
                name="search"
                value={search}
                placeholder={t('products.searchPlaceholder')}
                class="min-w-0 flex-1 rounded-lg border border-border py-sm px-md focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              />
              <button
                type="submit"
                class="shrink-0 whitespace-nowrap rounded-md bg-primary px-lg py-sm text-white transition-colors hover:bg-primary-dark"
              >
                {t('products.searchLabel')}
              </button>
            </div>
            <!-- Preserve other filters -->
            {type !== 'all' && <input type="hidden" name="type" value={type} />}
            {minPrice && <input type="hidden" name="minPrice" value={minPrice} />}
            {maxPrice && <input type="hidden" name="maxPrice" value={maxPrice} />}
            {minSize && <input type="hidden" name="minSize" value={minSize} />}
            {maxSize && <input type="hidden" name="maxSize" value={maxSize} />}
            {sortBy !== 'newest' && <input type="hidden" name="sort" value={sortBy} />}
          </form>
        </div>
      )}

      <!-- Active Filter Pills -->
      {hasActiveFilters && !error && (
        <div class="mb-lg flex flex-wrap gap-sm">
          {type !== 'all' && (
            <span class="inline-flex items-center gap-xs rounded-full bg-primary-light/30 px-sm py-xs text-sm text-primary-dark">
              <span>{t('products.typeLabel')}: {type}</span>
              <a
                href={buildClearFilterUrl('type')}
                class="hover:text-primary"
                aria-label="Clear type filter"
              >
                √ó
              </a>
            </span>
          )}

          {search && (
            <span class="inline-flex items-center gap-xs rounded-full bg-primary-light/30 px-sm py-xs text-sm text-primary-dark">
              <span>{t('products.searchLabel')}: "{search}"</span>
              <a
                href={buildClearFilterUrl('search')}
                class="hover:text-primary"
                aria-label="Clear search"
              >
                √ó
              </a>
            </span>
          )}

          {minPrice && (
            <span class="inline-flex items-center gap-xs rounded-full bg-primary-light/30 px-sm py-xs text-sm text-primary-dark">
              <span>{t('search.minPrice')}: ${minPrice}</span>
              <a
                href={buildClearFilterUrl('minPrice')}
                class="hover:text-primary"
                aria-label="Clear min price"
              >
                √ó
              </a>
            </span>
          )}

          {maxPrice && (
            <span class="inline-flex items-center gap-xs rounded-full bg-primary-light/30 px-sm py-xs text-sm text-primary-dark">
              <span>{t('search.maxPrice')}: ${maxPrice}</span>
              <a
                href={buildClearFilterUrl('maxPrice')}
                class="hover:text-primary"
                aria-label="Clear max price"
              >
                √ó
              </a>
            </span>
          )}

          {minSize && (
            <span class="inline-flex items-center gap-xs rounded-full bg-primary-light/30 px-sm py-xs text-sm text-primary-dark">
              <span>{t('products.minSize')}: {minSize} MB</span>
              <a
                href={buildClearFilterUrl('minSize')}
                class="hover:text-primary"
                aria-label="Clear min size"
              >
                √ó
              </a>
            </span>
          )}

          {maxSize && (
            <span class="inline-flex items-center gap-xs rounded-full bg-primary-light/30 px-sm py-xs text-sm text-primary-dark">
              <span>{t('products.maxSize')}: {maxSize} MB</span>
              <a
                href={buildClearFilterUrl('maxSize')}
                class="hover:text-primary"
                aria-label="Clear max size"
              >
                √ó
              </a>
            </span>
          )}

          <a
            href="/products"
            class="inline-flex items-center px-sm py-xs text-sm text-primary hover:underline"
          >
            {t('products.clearAllFilters')}
          </a>
        </div>
      )}

      <!-- Main Content: Filters Sidebar + Products Grid -->
      <div class="flex flex-col gap-2xl lg:flex-row">
        <!-- Filters Sidebar -->
        {!error && (
          <ProductFilters
            currentType={type}
            currentMinPrice={minPrice}
            currentMaxPrice={maxPrice}
            currentMinSize={minSize}
            currentMaxSize={maxSize}
            currentSort={sortBy}
          />
        )}

        <!-- Products Section -->
        <div class="flex-1">
          <!-- Results Count -->
          <div class="mb-lg">
            <p class="text-text-light">
              {products.length === 0 ? (
                <span>{t('products.noProductsFound')}</span>
              ) : (
                <span>
                  {products.length === 1
                    ? t('products.showingProductSingular', { count: products.length })
                    : t('products.showingProducts', { count: products.length })}
                </span>
              )}
            </p>
          </div>

          <!-- Products Grid -->
          {products.length > 0 ? (
            <>
              <div class="mb-2xl grid grid-cols-1 gap-xl sm:grid-cols-2 lg:grid-cols-3">
                {products.map(product => (
                  <ProductCard product={product} />
                ))}
              </div>

              <!-- Pagination -->
              {(hasPrevPage || hasNextPage) && (
                <nav aria-label="Pagination" class="flex items-center justify-center gap-sm">
                  {hasPrevPage ? (
                    <a
                      href={buildPageUrl(page - 1)}
                      class="rounded-md border border-border px-md py-sm transition-colors hover:bg-surface"
                      aria-label="Previous page"
                    >
                      ‚Üê {t('pagination.previous')}
                    </a>
                  ) : (
                    <span class="cursor-not-allowed rounded-md border border-border bg-surface px-md py-sm text-text-lighter" aria-disabled="true">
                      ‚Üê {t('pagination.previous')}
                    </span>
                  )}

                  <span class="px-md py-sm text-text">
                    {t('pagination.page')} {page}
                  </span>

                  {hasNextPage ? (
                    <a
                      href={buildPageUrl(page + 1)}
                      class="rounded-md border border-border px-md py-sm transition-colors hover:bg-surface"
                      aria-label="Next page"
                    >
                      {t('pagination.next')} ‚Üí
                    </a>
                  ) : (
                    <span class="cursor-not-allowed rounded-md border border-border bg-surface px-md py-sm text-text-lighter" aria-disabled="true">
                      {t('pagination.next')} ‚Üí
                    </span>
                  )}
                </nav>
              )}
            </>
          ) : (
            <div class="py-3xl text-center">
              <div class="mb-md text-6xl">
                {hasActiveFilters ? 'üîç' : 'üì¶'}
              </div>
              <h3 class="mb-sm text-xl font-semibold text-text">
                {hasActiveFilters ? t('products.noProductsFound') : t('products.noProductsAvailable')}
              </h3>
              <p class="mb-lg text-text-light">
                {hasActiveFilters
                  ? t('products.tryAdjustingFilters')
                  : t('products.checkBackLater')}
              </p>
              {hasActiveFilters && (
                <a
                  href="/products"
                  class="inline-block rounded-md bg-primary px-xl py-sm font-medium text-white transition-colors hover:bg-primary-dark"
                >
                  {t('products.clearFilters')}
                </a>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  </main>
</BaseLayout>
