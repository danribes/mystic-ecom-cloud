---
/**
 * Admin Users Management Page
 *
 * Allows administrators to:
 * - View all registered users
 * - Search and filter users
 * - Change user roles (promote/demote admins)
 */

import AdminLayout from '@/layouts/AdminLayout.astro';
import { listUsers, getUserStats } from '@/services/user.service';
import type { User } from '@/services/user.service';
import { useTranslations } from '@/lib/pageTranslations';

const { locale, t } = useTranslations(Astro.locals);

const title = t('admin.userManagement');
const description = t('admin.userManagementDesc');

// Get query parameters
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1', 10);
const limit = parseInt(url.searchParams.get('limit') || '10', 10);
const search = url.searchParams.get('search') || '';
const roleFilter = (url.searchParams.get('role') || '') as 'user' | 'admin' | '';
const sortBy = (url.searchParams.get('sortBy') || 'created_at') as 'name' | 'email' | 'created_at' | 'role';
const sortOrder = (url.searchParams.get('sortOrder') || 'DESC') as 'ASC' | 'DESC';

// Get current admin user ID
const currentUserId = Astro.locals.user?.id;

let users: User[] = [];
let total = 0;
let totalPages = 0;
let stats = { totalUsers: 0, totalAdmins: 0, newUsersThisMonth: 0, verifiedUsers: 0 };
let error: string | null = null;

try {
  const result = await listUsers({
    page,
    limit,
    search,
    role: roleFilter,
    sortBy,
    sortOrder
  });

  users = result.users;
  total = result.total;
  totalPages = result.totalPages;

  stats = await getUserStats();
} catch (e) {
  console.error('Error loading users:', e);
  error = 'Failed to load users. Please try again.';
}

// Format date
const formatDate = (date: Date): string => {
  return new Intl.DateTimeFormat(locale === 'es' ? 'es-ES' : 'en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  }).format(new Date(date));
};

// Build URL with updated params
const buildUrl = (params: Record<string, string | number>) => {
  const newUrl = new URL(url);
  Object.entries(params).forEach(([key, value]) => {
    if (value) {
      newUrl.searchParams.set(key, String(value));
    } else {
      newUrl.searchParams.delete(key);
    }
  });
  return newUrl.pathname + newUrl.search;
};

// Generate pagination numbers
const generatePaginationNumbers = (): number[] => {
  const numbers: number[] = [];
  const maxVisible = 5;

  if (totalPages <= maxVisible) {
    for (let i = 1; i <= totalPages; i++) {
      numbers.push(i);
    }
  } else if (page <= 3) {
    for (let i = 1; i <= maxVisible; i++) {
      numbers.push(i);
    }
  } else if (page >= totalPages - 2) {
    for (let i = totalPages - maxVisible + 1; i <= totalPages; i++) {
      numbers.push(i);
    }
  } else {
    for (let i = page - 2; i <= page + 2; i++) {
      numbers.push(i);
    }
  }

  return numbers;
};

const paginationNumbers = generatePaginationNumbers();
---

<AdminLayout title={title} description={description}>
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">{t('admin.totalUsers')}</p>
          <p class="text-2xl font-bold text-gray-900">{stats.totalUsers}</p>
        </div>
        <span class="text-3xl">üë•</span>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">{t('admin.administrators')}</p>
          <p class="text-2xl font-bold text-purple-600">{stats.totalAdmins}</p>
        </div>
        <span class="text-3xl">üîê</span>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">{t('admin.newThisMonth')}</p>
          <p class="text-2xl font-bold text-green-600">{stats.newUsersThisMonth}</p>
        </div>
        <span class="text-3xl">üìà</span>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">{t('admin.verifiedEmail')}</p>
          <p class="text-2xl font-bold text-blue-600">{stats.verifiedUsers}</p>
        </div>
        <span class="text-3xl">‚úÖ</span>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  {error && (
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
      <p class="text-red-800">{error}</p>
    </div>
  )}

  <!-- Filters -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
    <form method="GET" class="flex flex-wrap gap-4 items-end">
      <div class="flex-1 min-w-[200px]">
        <label for="search" class="block text-sm font-medium text-gray-700 mb-1">{t('common.search')}</label>
        <input
          type="text"
          id="search"
          name="search"
          value={search}
          placeholder={t('admin.searchPlaceholder')}
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
        />
      </div>

      <div class="w-40">
        <label for="role" class="block text-sm font-medium text-gray-700 mb-1">{t('admin.role')}</label>
        <select
          id="role"
          name="role"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
        >
          <option value="">{t('admin.allRoles')}</option>
          <option value="user" selected={roleFilter === 'user'}>{t('admin.users')}</option>
          <option value="admin" selected={roleFilter === 'admin'}>{t('admin.admins')}</option>
        </select>
      </div>

      <div class="w-40">
        <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-1">{t('admin.sortBy')}</label>
        <select
          id="sortBy"
          name="sortBy"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
        >
          <option value="created_at" selected={sortBy === 'created_at'}>{t('admin.dateJoined')}</option>
          <option value="name" selected={sortBy === 'name'}>{t('admin.name')}</option>
          <option value="email" selected={sortBy === 'email'}>{t('admin.email')}</option>
          <option value="role" selected={sortBy === 'role'}>{t('admin.role')}</option>
        </select>
      </div>

      <div class="w-32">
        <label for="sortOrder" class="block text-sm font-medium text-gray-700 mb-1">{t('admin.order')}</label>
        <select
          id="sortOrder"
          name="sortOrder"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
        >
          <option value="DESC" selected={sortOrder === 'DESC'}>{t('admin.newest')}</option>
          <option value="ASC" selected={sortOrder === 'ASC'}>{t('admin.oldest')}</option>
        </select>
      </div>

      <button
        type="submit"
        class="px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-colors"
      >
        {t('admin.filter')}
      </button>

      {(search || roleFilter) && (
        <a
          href="/admin/users"
          class="px-4 py-2 text-gray-600 hover:text-gray-900 font-medium"
        >
          {t('admin.clear')}
        </a>
      )}
    </form>
  </div>

  <!-- Users Table -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-gray-900">
        {t('admin.users')} ({total})
      </h2>
    </div>

    {users.length > 0 ? (
      <div class="relative">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('admin.user')}</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('admin.role')}</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('admin.emailStatus')}</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('admin.joined')}</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{t('admin.actions')}</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {users.map((user) => (
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                      <span class="text-purple-600 font-semibold">
                        {user.name.charAt(0).toUpperCase()}
                      </span>
                    </div>
                    <div class="ml-3">
                      <div class="text-sm font-medium text-gray-900">{user.name}</div>
                      <div class="text-sm text-gray-500">{user.email}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                    user.role === 'admin'
                      ? 'bg-purple-100 text-purple-800'
                      : 'bg-gray-100 text-gray-800'
                  }`}>
                    {user.role === 'admin' ? `üîê ${t('admin.adminBadge')}` : `üë§ ${t('admin.userBadge')}`}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                    user.email_verified
                      ? 'bg-green-100 text-green-800'
                      : 'bg-yellow-100 text-yellow-800'
                  }`}>
                    {user.email_verified ? `‚úÖ ${t('admin.verified')}` : `‚è≥ ${t('admin.pendingVerification')}`}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {formatDate(user.created_at)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <div class="relative">
                    <button
                      type="button"
                      class="actions-menu-btn p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors"
                      data-user-id={user.id}
                      aria-label="User actions"
                    >
                      <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                      </svg>
                    </button>
                    <div
                      class="actions-dropdown hidden fixed z-[9999] w-48 rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
                      data-user-id={user.id}
                    >
                      <div class="py-1">
                        <a
                          href={`/admin/users/${user.id}/edit`}
                          class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                        >
                          <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                          </svg>
                          {t('admin.editUser')}
                        </a>
                        {user.id !== currentUserId && (
                          <>
                            <button
                              type="button"
                              data-user-id={user.id}
                              data-user-name={user.name}
                              data-current-role={user.role}
                              class="role-toggle-btn flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            >
                              {user.role === 'admin' ? (
                                <>
                                  <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                                  </svg>
                                  {t('admin.removeAdmin')}
                                </>
                              ) : (
                                <>
                                  <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                  </svg>
                                  {t('admin.makeAdmin')}
                                </>
                              )}
                            </button>
                            <div class="border-t border-gray-100 my-1"></div>
                            <button
                              type="button"
                              data-user-id={user.id}
                              data-user-name={user.name}
                              class="delete-user-btn flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50"
                            >
                              <svg class="w-4 h-4 mr-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                              {t('admin.deleteUser')}
                            </button>
                          </>
                        )}
                        {user.id === currentUserId && (
                          <span class="flex items-center px-4 py-2 text-sm text-gray-400 italic">
                            <svg class="w-4 h-4 mr-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            {t('admin.currentUser')}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            ))}
            <!-- Add User Row -->
            <tr class="hover:bg-gray-50 border-t border-dashed border-gray-200">
              <td colspan="5" class="px-6 py-4">
                <a
                  href="/admin/users/new"
                  class="flex items-center justify-center w-full py-2 text-purple-600 hover:text-purple-800 hover:bg-purple-50 rounded-lg transition-colors group"
                >
                  <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-purple-100 group-hover:bg-purple-200 flex items-center justify-center transition-colors">
                      <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                      </svg>
                    </div>
                    <span class="font-medium">{t('admin.addNewUser')}</span>
                  </div>
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    ) : (
      <div class="text-center py-12">
        <span class="text-4xl">üë•</span>
        <h3 class="mt-2 text-sm font-medium text-gray-900">{t('admin.noUsersFound')}</h3>
        <p class="mt-1 text-sm text-gray-500">{t('admin.noUsersMessage')}</p>
      </div>
    )}

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
        <div class="text-sm text-gray-500">
          {t('admin.showingRange', { start: ((page - 1) * limit) + 1, end: Math.min(page * limit, total), total })}
        </div>
        <div class="flex gap-2">
          {page > 1 && (
            <a
              href={buildUrl({ page: page - 1 })}
              class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50"
            >
              {t('common.previous')}
            </a>
          )}

          {paginationNumbers.map((pageNum) => (
            <a
              href={buildUrl({ page: pageNum })}
              class={`px-3 py-1 border rounded-md text-sm ${
                pageNum === page
                  ? 'bg-purple-600 text-white border-purple-600'
                  : 'border-gray-300 hover:bg-gray-50'
              }`}
            >
              {pageNum}
            </a>
          ))}

          {page < totalPages && (
            <a
              href={buildUrl({ page: page + 1 })}
              class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50"
            >
              {t('common.next')}
            </a>
          )}
        </div>
      </div>
    )}
  </div>

  <!-- Role Change Confirmation Modal -->
  <div
    id="role-modal"
    class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center"
    data-promote-title={t('admin.promoteToAdmin')}
    data-demote-title={t('admin.removeAdminRole')}
    data-promote-message={t('admin.promoteMessage', { name: '{{name}}' })}
    data-demote-message={t('admin.demoteMessage', { name: '{{name}}' })}
    data-confirm-text={t('admin.confirm')}
    data-updating-text={t('admin.updating')}
  >
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-2" id="modal-title">{t('admin.changeUserRole')}</h3>
      <p class="text-gray-600 mb-4" id="modal-message"></p>

      <div class="flex justify-end gap-3">
        <button
          type="button"
          id="modal-cancel"
          class="px-4 py-2 text-gray-600 hover:text-gray-900 font-medium"
        >
          {t('admin.cancel')}
        </button>
        <button
          type="button"
          id="modal-confirm"
          class="px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700"
        >
          {t('admin.confirm')}
        </button>
      </div>
    </div>
  </div>

  <!-- Delete User Confirmation Modal -->
  <div
    id="delete-modal"
    class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center"
    data-delete-title={t('admin.deleteUserTitle')}
    data-delete-message={t('admin.deleteUserMessage', { name: '{{name}}' })}
    data-confirm-text={t('admin.delete')}
    data-deleting-text={t('admin.deleting')}
  >
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
      <div class="flex items-center mb-4">
        <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mr-3">
          <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900" id="delete-modal-title">{t('admin.deleteUser')}</h3>
      </div>
      <p class="text-gray-600 mb-6" id="delete-modal-message"></p>

      <div class="flex justify-end gap-3">
        <button
          type="button"
          id="delete-modal-cancel"
          class="px-4 py-2 text-gray-600 hover:text-gray-900 font-medium"
        >
          {t('admin.cancel')}
        </button>
        <button
          type="button"
          id="delete-modal-confirm"
          class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700"
        >
          {t('admin.delete')}
        </button>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // Dropdown menu and Role toggle functionality
  document.addEventListener('DOMContentLoaded', () => {
    // Dropdown menu handlers
    const menuButtons = document.querySelectorAll('.actions-menu-btn');
    const dropdowns = document.querySelectorAll('.actions-dropdown');

    // Toggle dropdown on button click
    menuButtons.forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const userId = btn.getAttribute('data-user-id');
        const dropdown = document.querySelector(`.actions-dropdown[data-user-id="${userId}"]`) as HTMLElement;

        // Close all other dropdowns
        dropdowns.forEach((d) => {
          if (d !== dropdown) {
            d.classList.add('hidden');
          }
        });

        // Position the dropdown relative to the button
        if (dropdown) {
          const rect = btn.getBoundingClientRect();
          dropdown.style.top = `${rect.bottom + 8}px`;
          dropdown.style.left = `${rect.right - 192}px`; // 192px = w-48 (12rem)

          // Make sure dropdown doesn't go off-screen to the left
          if (rect.right - 192 < 0) {
            dropdown.style.left = `${rect.left}px`;
          }
        }

        // Toggle current dropdown
        dropdown?.classList.toggle('hidden');
      });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
      dropdowns.forEach((d) => d.classList.add('hidden'));
    });

    // Prevent dropdown from closing when clicking inside
    dropdowns.forEach((dropdown) => {
      dropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });

    // Close dropdowns on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        dropdowns.forEach((d) => d.classList.add('hidden'));
      }
    });

    const modal = document.getElementById('role-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalCancel = document.getElementById('modal-cancel');
    const modalConfirm = document.getElementById('modal-confirm');

    // Get translated strings from data attributes
    const promoteTitle = modal?.getAttribute('data-promote-title') || 'Promote to Admin';
    const demoteTitle = modal?.getAttribute('data-demote-title') || 'Remove Admin Role';
    const promoteMessage = modal?.getAttribute('data-promote-message') || 'Are you sure you want to make "{{name}}" an administrator?';
    const demoteMessage = modal?.getAttribute('data-demote-message') || 'Are you sure you want to remove admin privileges from "{{name}}"?';
    const confirmText = modal?.getAttribute('data-confirm-text') || 'Confirm';
    const updatingText = modal?.getAttribute('data-updating-text') || 'Updating...';

    let pendingUserId: string | null = null;
    let pendingNewRole: string | null = null;

    // Add click handlers to all role toggle buttons
    document.querySelectorAll('.role-toggle-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const userId = btn.getAttribute('data-user-id');
        const userName = btn.getAttribute('data-user-name');
        const currentRole = btn.getAttribute('data-current-role');
        const newRole = currentRole === 'admin' ? 'user' : 'admin';

        pendingUserId = userId;
        pendingNewRole = newRole;

        if (modalTitle && modalMessage) {
          if (newRole === 'admin') {
            modalTitle.textContent = promoteTitle;
            modalMessage.textContent = promoteMessage.replace('{{name}}', userName || '');
          } else {
            modalTitle.textContent = demoteTitle;
            modalMessage.textContent = demoteMessage.replace('{{name}}', userName || '');
          }
        }

        modal?.classList.remove('hidden');
        modal?.classList.add('flex');
      });
    });

    // Cancel button
    modalCancel?.addEventListener('click', () => {
      modal?.classList.add('hidden');
      modal?.classList.remove('flex');
      pendingUserId = null;
      pendingNewRole = null;
    });

    // Click outside modal to close
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        pendingUserId = null;
        pendingNewRole = null;
      }
    });

    // Confirm button
    modalConfirm?.addEventListener('click', async () => {
      if (!pendingUserId || !pendingNewRole) return;

      modalConfirm.textContent = updatingText;
      modalConfirm.setAttribute('disabled', 'true');

      try {
        const response = await fetch('/api/admin/users/update-role', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId: pendingUserId,
            role: pendingNewRole,
          }),
        });

        const data = await response.json();

        if (data.success) {
          // Reload the page to show updated data
          window.location.reload();
        } else {
          alert(data.message || 'Failed to update user role');
          modal?.classList.add('hidden');
          modal?.classList.remove('flex');
        }
      } catch (error) {
        console.error('Error updating role:', error);
        alert('An error occurred. Please try again.');
        modal?.classList.add('hidden');
        modal?.classList.remove('flex');
      } finally {
        modalConfirm.textContent = confirmText;
        modalConfirm.removeAttribute('disabled');
        pendingUserId = null;
        pendingNewRole = null;
      }
    });

    // Delete user functionality
    const deleteModal = document.getElementById('delete-modal');
    const deleteModalTitle = document.getElementById('delete-modal-title');
    const deleteModalMessage = document.getElementById('delete-modal-message');
    const deleteModalCancel = document.getElementById('delete-modal-cancel');
    const deleteModalConfirm = document.getElementById('delete-modal-confirm');

    // Get translated strings from data attributes
    const deleteTitle = deleteModal?.getAttribute('data-delete-title') || 'Delete User';
    const deleteMessage = deleteModal?.getAttribute('data-delete-message') || 'Are you sure you want to delete "{{name}}"? This action cannot be undone.';
    const deleteConfirmText = deleteModal?.getAttribute('data-confirm-text') || 'Delete';
    const deletingText = deleteModal?.getAttribute('data-deleting-text') || 'Deleting...';

    let pendingDeleteUserId: string | null = null;

    // Add click handlers to all delete buttons
    document.querySelectorAll('.delete-user-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const userId = btn.getAttribute('data-user-id');
        const userName = btn.getAttribute('data-user-name');

        pendingDeleteUserId = userId;

        if (deleteModalTitle && deleteModalMessage) {
          deleteModalTitle.textContent = deleteTitle;
          deleteModalMessage.textContent = deleteMessage.replace('{{name}}', userName || '');
        }

        // Close dropdown
        dropdowns.forEach((d) => d.classList.add('hidden'));

        deleteModal?.classList.remove('hidden');
        deleteModal?.classList.add('flex');
      });
    });

    // Cancel delete button
    deleteModalCancel?.addEventListener('click', () => {
      deleteModal?.classList.add('hidden');
      deleteModal?.classList.remove('flex');
      pendingDeleteUserId = null;
    });

    // Click outside delete modal to close
    deleteModal?.addEventListener('click', (e) => {
      if (e.target === deleteModal) {
        deleteModal.classList.add('hidden');
        deleteModal.classList.remove('flex');
        pendingDeleteUserId = null;
      }
    });

    // Confirm delete button
    deleteModalConfirm?.addEventListener('click', async () => {
      if (!pendingDeleteUserId) return;

      deleteModalConfirm.textContent = deletingText;
      deleteModalConfirm.setAttribute('disabled', 'true');

      try {
        const response = await fetch('/api/admin/users/delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId: pendingDeleteUserId,
          }),
        });

        const data = await response.json();

        if (data.success) {
          // Reload the page to show updated data
          window.location.reload();
        } else {
          alert(data.message || 'Failed to delete user');
          deleteModal?.classList.add('hidden');
          deleteModal?.classList.remove('flex');
        }
      } catch (error) {
        console.error('Error deleting user:', error);
        alert('An error occurred. Please try again.');
        deleteModal?.classList.add('hidden');
        deleteModal?.classList.remove('flex');
      } finally {
        deleteModalConfirm.textContent = deleteConfirmText;
        deleteModalConfirm.removeAttribute('disabled');
        pendingDeleteUserId = null;
      }
    });
  });
</script>
