---
/**
 * T102: Admin Edit Digital Product Page
 *
 * Form for editing existing digital products with:
 * - File upload for product image and downloadable files
 * - Product type selection (PDF, audio, video, ebook)
 * - Price and metadata management
 * - Publication status toggle
 */

import AdminLayout from '@/layouts/AdminLayout.astro';
import FileUpload from '@/components/FileUpload.astro';
import { checkAdminAuth } from '@/lib/auth/admin';
import { getPool } from '@/lib/db';

export const prerender = false;

// Check admin authentication
const authResult = await checkAdminAuth(Astro.cookies, Astro.url.pathname);
if (authResult.shouldRedirect) {
  return Astro.redirect(authResult.redirectTo!);
}

// Get product ID from URL
const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/products');
}

// Load product from database
const pool = getPool();
let product: any = null;
let notFound = false;

try {
  const result = await pool.query(
    'SELECT * FROM digital_products WHERE id = $1',
    [id]
  );

  if (result.rows.length === 0) {
    notFound = true;
  } else {
    product = result.rows[0];
  }
} catch (error) {
  console.error('Error loading product:', error);
  return Astro.redirect('/admin/products?error=load-failed');
}

if (notFound) {
  return Astro.redirect('/admin/products?error=not-found');
}

// Product type options
const productTypes = [
  { value: 'pdf', label: 'PDF Document', icon: 'ðŸ“„' },
  { value: 'audio', label: 'Audio File', icon: 'ðŸŽµ' },
  { value: 'video', label: 'Video File', icon: 'ðŸŽ¥' },
  { value: 'ebook', label: 'eBook', icon: 'ðŸ“š' }
];

// Get accept types based on product type
const getAcceptType = (productType: string): string => {
  switch (productType) {
    case 'pdf':
      return 'application/pdf';
    case 'audio':
      return 'audio/*';
    case 'video':
      return 'video/*';
    case 'ebook':
      return 'application/pdf,application/epub+zip,.epub,.mobi';
    default:
      return '*/*';
  }
};
---

<AdminLayout title={`Edit: ${product.title}`}>
  <div class="max-w-5xl mx-auto">
    <div class="bg-white rounded-lg shadow-sm border">
      <div class="px-6 py-4 border-b">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Edit Product</h1>
            <p class="text-sm text-gray-600 mt-1">Update product details and files</p>
          </div>
          <a
            href="/admin/products"
            class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"
          >
            Back to Products
          </a>
        </div>
      </div>

      <form id="productForm" class="p-6 space-y-8" data-product-id={product.id}>
        {/* Basic Information */}
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Basic Information
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
                Title <span class="text-red-600">*</span>
              </label>
              <input
                type="text"
                id="title"
                name="title"
                required
                maxlength="255"
                value={product.title}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="e.g., Complete Meditation Guide"
              />
            </div>

            <div class="md:col-span-2">
              <label for="slug" class="block text-sm font-medium text-gray-700 mb-1">
                URL Slug <span class="text-red-600">*</span>
              </label>
              <input
                type="text"
                id="slug"
                name="slug"
                required
                maxlength="255"
                pattern="[a-z0-9-]+"
                value={product.slug}
                data-original-slug={product.slug}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors font-mono"
                placeholder="complete-meditation-guide"
              />
              <p class="mt-1 text-xs text-gray-500">Auto-generated from title (editable)</p>
              <p class="mt-1 text-xs text-amber-600 hidden" id="slugWarning">
                Warning: Changing the slug will break existing links to this product
              </p>
            </div>
          </div>

          <div>
            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
              Description <span class="text-red-600">*</span>
            </label>
            <textarea
              id="description"
              name="description"
              required
              rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
              placeholder="Describe your product in detail..."
            >{product.description}</textarea>
          </div>
        </div>

        {/* Product Details */}
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Product Details
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="productType" class="block text-sm font-medium text-gray-700 mb-1">
                Product Type <span class="text-red-600">*</span>
              </label>
              <select
                id="productType"
                name="productType"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
              >
                <option value="">Select type...</option>
                {productTypes.map(type => (
                  <option value={type.value} selected={product.product_type === type.value}>
                    {type.icon} {type.label}
                  </option>
                ))}
              </select>
              <p class="mt-1 text-xs text-gray-500">Type of digital file</p>
            </div>

            <div>
              <label for="price" class="block text-sm font-medium text-gray-700 mb-1">
                Price ($) <span class="text-red-600">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-gray-500">$</span>
                <input
                  type="number"
                  id="price"
                  name="price"
                  required
                  min="0"
                  step="0.01"
                  value={Number(product.price).toFixed(2)}
                  class="w-full pl-7 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                  placeholder="29.99"
                />
              </div>
              <p class="mt-1 text-xs text-gray-500">Enter 0 for free products</p>
            </div>

            <div>
              <label for="fileSizeMb" class="block text-sm font-medium text-gray-700 mb-1">
                File Size (MB)
              </label>
              <input
                type="number"
                id="fileSizeMb"
                name="fileSizeMb"
                min="0"
                step="0.01"
                value={product.file_size_mb ? Number(product.file_size_mb).toFixed(2) : ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="5.5"
              />
              <p class="mt-1 text-xs text-gray-500">Size of the downloadable file</p>
            </div>

            <div>
              <label for="downloadLimit" class="block text-sm font-medium text-gray-700 mb-1">
                Download Limit
              </label>
              <input
                type="number"
                id="downloadLimit"
                name="downloadLimit"
                min="1"
                value={product.download_limit || 3}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="3"
              />
              <p class="mt-1 text-xs text-gray-500">Times customer can download</p>
            </div>
          </div>
        </div>

        {/* Files & Media */}
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Files & Media
          </h2>

          <FileUpload
            name="imageUrl"
            label="Product Image"
            accept="image/*"
            maxSize={10 * 1024 * 1024}
            currentValue={product.image_url}
            helpText="Cover image or thumbnail (max 10MB). Recommended: 800x800px"
            folder="products/images"
          />

          <FileUpload
            name="fileUrl"
            label="Downloadable File"
            accept={getAcceptType(product.product_type || 'pdf')}
            maxSize={500 * 1024 * 1024}
            currentValue={product.file_url}
            required={true}
            helpText="The main file customers will download (max 500MB)"
            folder="products/files"
          />

          <FileUpload
            name="previewUrl"
            label="Preview File (Optional)"
            accept={getAcceptType(product.product_type || 'pdf')}
            maxSize={50 * 1024 * 1024}
            currentValue={product.preview_url}
            helpText="Optional sample or preview file (max 50MB)"
            folder="products/previews"
          />
        </div>

        {/* Publication Status */}
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Publication Status
          </h2>

          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="isPublished"
              checked={product.is_published}
              class="h-5 w-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500"
            />
            <span class="ml-2 text-sm text-gray-700">Publish this product (make it visible to customers)</span>
          </label>

          {/* Product Metadata */}
          <div class="mt-4 pt-4 border-t border-gray-200">
            <dl class="grid grid-cols-1 gap-x-4 gap-y-2 sm:grid-cols-2 text-sm">
              <div>
                <dt class="font-medium text-gray-500">Created</dt>
                <dd class="text-gray-900">{new Date(product.created_at).toLocaleString()}</dd>
              </div>
              <div>
                <dt class="font-medium text-gray-500">Last Updated</dt>
                <dd class="text-gray-900">{new Date(product.updated_at).toLocaleString()}</dd>
              </div>
            </dl>
          </div>
        </div>

        {/* Spanish Translations (T168 i18n) */}
        <div class="space-y-4 bg-orange-50 border border-orange-200 rounded-lg p-6">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <span class="text-xl">ðŸ‡ªðŸ‡¸</span>
            Spanish Translations (Optional)
          </h2>
          <p class="text-sm text-gray-600">
            Provide Spanish translations for your product. Leave blank to use the English content.
          </p>

          <div>
            <label for="title_es" class="block text-sm font-medium text-gray-700 mb-1">
              Title (Spanish)
            </label>
            <input
              type="text"
              id="title_es"
              name="title_es"
              maxlength="255"
              value={product.title_es || ''}
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors"
              placeholder="e.g., GuÃ­a Completa de MeditaciÃ³n"
            />
          </div>

          <div>
            <label for="description_es" class="block text-sm font-medium text-gray-700 mb-1">
              Description (Spanish)
            </label>
            <textarea
              id="description_es"
              name="description_es"
              rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors"
              placeholder="Describe tu producto en detalle..."
            >{product.description_es || ''}</textarea>
          </div>
        </div>

        {/* Submit */}
        <div class="flex gap-4 justify-end pt-4 border-t">
          <a
            href="/admin/products"
            class="px-6 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"
          >
            Cancel
          </a>
          <button
            type="submit"
            id="submitBtn"
            class="px-6 py-2 text-white bg-purple-600 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
          >
            <span id="submitText">Update Product</span>
            <svg id="submitSpinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<!-- Slug generation script -->
<script is:inline define:vars={{ originalSlug: product.slug }}>
document.addEventListener('DOMContentLoaded', () => {
  const titleInput = document.getElementById('title');
  const slugInput = document.getElementById('slug');
  const slugWarning = document.getElementById('slugWarning');

  if (titleInput && slugInput && slugWarning) {
    // Initialize previous value
    titleInput.dataset.previousValue = titleInput.value;

    titleInput.addEventListener('input', () => {
      const currentSlug = slugInput.value;
      const autoSlug = titleInput.value
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');

      // Update slug if it matches the previous auto-generated pattern
      const previousAutoSlug = (titleInput.dataset.previousValue || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');

      if (!currentSlug || currentSlug === previousAutoSlug) {
        slugInput.value = autoSlug;
      }

      titleInput.dataset.previousValue = titleInput.value;
    });

    slugInput.addEventListener('input', () => {
      // Show warning if slug changed from original
      if (slugInput.value !== originalSlug) {
        slugWarning.classList.remove('hidden');
      } else {
        slugWarning.classList.add('hidden');
      }
    });
  }
});
</script>

<script>
import { useToast } from '@/lib/toast';

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('productForm') as HTMLFormElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
  const submitText = document.getElementById('submitText') as HTMLSpanElement;
  const submitSpinner = document.getElementById('submitSpinner') as SVGElement;
  const toast = useToast();

  if (!form) {
    console.error('Product form not found!');
    return;
  }

  function setLoading(loading: boolean) {
    if (submitBtn && submitText && submitSpinner) {
      submitBtn.disabled = loading;
      submitText.textContent = loading ? 'Updating...' : 'Update Product';
      submitSpinner.classList.toggle('hidden', !loading);
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Manual validation for required fields
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    let firstInvalidField: HTMLElement | null = null;

    requiredFields.forEach((field) => {
      const input = field as HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement;
      if (!input.value.trim()) {
        input.setAttribute('aria-invalid', 'true');
        input.classList.add('border-red-500', 'ring-2', 'ring-red-500');
        isValid = false;
        if (!firstInvalidField) {
          firstInvalidField = input;
        }
      } else {
        input.removeAttribute('aria-invalid');
        input.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
      }
    });

    // Also check hidden inputs with data-required
    const hiddenRequired = form.querySelectorAll('input[type="hidden"][data-required="true"]');
    hiddenRequired.forEach((field) => {
      const input = field as HTMLInputElement;
      if (!input.value.trim()) {
        isValid = false;
        toast.error(`Please upload the ${input.name.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
      }
    });

    if (!isValid && firstInvalidField) {
      firstInvalidField.focus();
      toast.error('Please fill in all required fields');
      return;
    }

    setLoading(true);

    try {
      const formData = new FormData(form);
      const productId = form.dataset.productId;

      if (!productId) {
        throw new Error('Product ID not found');
      }

      // Build product object
      const productData = {
        title: formData.get('title') as string,
        slug: formData.get('slug') as string,
        description: formData.get('description') as string,
        product_type: formData.get('productType') as string,
        price: parseFloat(formData.get('price') as string) || 0,
        file_url: formData.get('fileUrl') as string,
        file_size_mb: parseFloat(formData.get('fileSizeMb') as string) || null,
        preview_url: (formData.get('previewUrl') as string) || null,
        image_url: (formData.get('imageUrl') as string) || null,
        download_limit: parseInt(formData.get('downloadLimit') as string) || 3,
        is_published: formData.get('isPublished') === 'on',
        // Spanish translation fields (T168 i18n)
        title_es: (formData.get('title_es') as string)?.trim() || null,
        description_es: (formData.get('description_es') as string)?.trim() || null,
      };

      // Client-side validation
      if (!productData.title || productData.title.length < 3) {
        throw new Error('Title must be at least 3 characters long');
      }

      if (!productData.slug || !/^[a-z0-9-]+$/.test(productData.slug)) {
        throw new Error('Slug must contain only lowercase letters, numbers, and hyphens');
      }

      if (!productData.description || productData.description.length < 10) {
        throw new Error('Description must be at least 10 characters long');
      }

      if (!productData.product_type) {
        throw new Error('Please select a product type');
      }

      if (productData.price < 0) {
        throw new Error('Price cannot be negative');
      }

      if (!productData.file_url) {
        throw new Error('Downloadable file is required');
      }

      // Submit to API
      const response = await fetch(`/api/admin/products/${productId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(productData),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to update product');
      }

      const result = await response.json();

      // Show success message
      toast.success('Product updated successfully');

      // Redirect to product list after a brief delay
      setTimeout(() => {
        window.location.href = '/admin/products';
      }, 1000);
    } catch (error: any) {
      console.error('Error updating product:', error);
      setLoading(false);
      toast.error(error.message || 'Failed to update product');
    }
  });
});
</script>
