---
import AdminLayout from '@/layouts/AdminLayout.astro';
import FileUpload from '@/components/FileUpload.astro';
import type { CourseLevel } from '@/types';
import { getSessionFromRequest } from '@/lib/auth/session';

export const prerender = false; // Enable SSR for authentication

// Check authentication
const session = await getSessionFromRequest(Astro.cookies);
if (!session) {
  return Astro.redirect('/login?redirect=/admin/courses/new');
}

// Get user ID from session
const userId = session.userId;

// Course level options
const courseLevels: CourseLevel[] = ['beginner', 'intermediate', 'advanced'];
---

<AdminLayout title="Create New Course">
  <div class="p-6 bg-white rounded-lg shadow">
    <h1 class="text-2xl font-bold mb-6">Create New Course</h1>
    
    <form id="courseForm" class="space-y-6" data-user-id={userId}>
      {/* Basic Information */}
      <div class="space-y-4">
        <h2 class="text-lg font-semibold">Basic Information</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <label for="title" class="block font-medium">
              Title <span class="text-red-600">*</span>
            </label>
            <input 
              type="text" 
              id="title"
              name="title"
              required
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Enter course title"
            />
          </div>
          
          <div class="space-y-2">
            <label for="slug" class="block font-medium">
              Slug <span class="text-red-600">*</span>
            </label>
            <input 
              type="text" 
              id="slug"
              name="slug"
              required
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="course-url-slug"
            />
          </div>
        </div>

        <div>
          <label for="description" class="block font-medium mb-2">
            Short Description <span class="text-red-600">*</span>
          </label>
          <textarea 
            id="description"
            name="description"
            required
            rows="3"
            class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="Brief description of the course"
          ></textarea>
        </div>

        <div>
          <label for="longDescription" class="block font-medium mb-2">
            Long Description
          </label>
          <textarea 
            id="longDescription"
            name="longDescription"
            rows="6"
            class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="Detailed description of the course"
          ></textarea>
        </div>
      </div>

      {/* Course Details */}
      <div class="space-y-4">
        <h2 class="text-lg font-semibold">Course Details</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="space-y-2">
            <label for="price" class="block font-medium">
              Price (in cents) <span class="text-red-600">*</span>
            </label>
            <input 
              type="number" 
              id="price"
              name="price"
              required
              min="0"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="e.g. 9900 for $99.00"
            />
          </div>

          <div class="space-y-2">
            <label for="duration" class="block font-medium">
              Duration (in seconds) <span class="text-red-600">*</span>
            </label>
            <input 
              type="number" 
              id="duration"
              name="duration"
              required
              min="0"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Total duration in seconds"
            />
          </div>

          <div class="space-y-2">
            <label for="level" class="block font-medium">
              Level <span class="text-red-600">*</span>
            </label>
            <select 
              id="level"
              name="level"
              required
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Select Level</option>
              {courseLevels.map(level => (
                <option value={level}>{level.charAt(0).toUpperCase() + level.slice(1)}</option>
              ))}
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <label for="category" class="block font-medium">
              Category <span class="text-red-600">*</span>
            </label>
            <input 
              type="text" 
              id="category"
              name="category"
              required
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Course category"
            />
          </div>

          <div class="space-y-2">
            <label for="tags" class="block font-medium">
              Tags (comma-separated)
            </label>
            <input 
              type="text" 
              id="tags"
              name="tags"
              class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="meditation, mindfulness, etc."
            />
          </div>
        </div>
      </div>

      {/* Media */}
      <div class="space-y-4">
        <h2 class="text-lg font-semibold">Media</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <FileUpload 
            name="imageUrl"
            label="Main Image"
            accept="image/*"
            maxSize={10485760}
            helpText="Upload the main course image (max 10MB)"
          />

          <FileUpload 
            name="thumbnailUrl"
            label="Thumbnail"
            accept="image/*"
            maxSize={10485760}
            helpText="Upload a thumbnail image (max 10MB)"
          />

          <FileUpload 
            name="previewVideoUrl"
            label="Preview Video"
            accept="video/*"
            maxSize={52428800}
            helpText="Upload a preview video (max 50MB)"
          />
        </div>
      </div>

      {/* Learning Content */}
      <div class="space-y-4">
        <h2 class="text-lg font-semibold">Learning Content</h2>
        
        <div class="space-y-2">
          <label for="learningOutcomes" class="block font-medium">
            Learning Outcomes (one per line)
          </label>
          <textarea 
            id="learningOutcomes"
            name="learningOutcomes"
            rows="4"
            class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="What students will learn&#10;Each line will be a separate outcome"
          ></textarea>
        </div>

        <div class="space-y-2">
          <label for="prerequisites" class="block font-medium">
            Prerequisites (one per line)
          </label>
          <textarea 
            id="prerequisites"
            name="prerequisites"
            rows="4"
            class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="Required prerequisites&#10;Each line will be a separate item"
          ></textarea>
        </div>

        <div class="space-y-2">
          <label class="block font-medium">Course Status</label>
          <div class="flex gap-4">
            <label class="inline-flex items-center">
              <input
                type="checkbox"
                name="isPublished"
                class="h-5 w-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500"
              />
              <span class="ml-2">Publish immediately</span>
            </label>

            <label class="inline-flex items-center">
              <input
                type="checkbox"
                name="isFeatured"
                class="h-5 w-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500"
              />
              <span class="ml-2">Featured course</span>
            </label>
          </div>
        </div>
      </div>

      {/* Submit */}
      <div class="flex gap-4 justify-end pt-4">
        <a 
          href="/admin/courses" 
          class="px-4 py-2 text-gray-700 bg-gray-100 rounded hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
        >
          Cancel
        </a>
        <button
          type="submit"
          class="px-4 py-2 text-white bg-blue-600 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        >
          Create Course
        </button>
      </div>
    </form>
  </div>
</AdminLayout>

<!-- Inline script for slug generation (no imports needed) -->
<script is:inline>
document.addEventListener('DOMContentLoaded', () => {
  const titleInput = document.getElementById('title');
  const slugInput = document.getElementById('slug');

  function generateSlug(text) {
    return text
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-|-$/g, '');
  }

  if (titleInput && slugInput) {
    const updateSlug = () => {
      slugInput.value = generateSlug(titleInput.value);
    };
    
    titleInput.addEventListener('input', updateSlug);
    titleInput.addEventListener('keyup', updateSlug);
    titleInput.addEventListener('change', updateSlug);
  }
});
</script>

<script>
import { useToast } from '@/lib/toast';
import type { CourseLevel } from '@/types';

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('courseForm') as HTMLFormElement;
  const toast = useToast();
  
  if (!form) {
    console.error('Course form not found!');
    return;
  }
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
  
    // Manual validation for required fields
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
  let firstInvalidField: HTMLElement | null = null;
  
  requiredFields.forEach((field) => {
    const input = field as HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement;
    if (!input.value.trim()) {
      input.setAttribute('aria-invalid', 'true');
      input.classList.add('border-red-500');
      isValid = false;
      if (!firstInvalidField) {
        firstInvalidField = input;
      }
    } else {
      input.removeAttribute('aria-invalid');
      input.classList.remove('border-red-500');
    }
  });
  
  if (!isValid && firstInvalidField) {
    firstInvalidField.focus();
    toast.error('Please fill in all required fields');
    return;
  }
  
  try {
    const formData = new FormData(form);
    
    // Get instructor ID from form data attribute
    const instructorId = form.dataset.userId;
    
    if (!instructorId) {
      throw new Error('User not found. Please log in again.');
    }

    // Parse form data into API payload
    const data = {
      title: formData.get('title') as string,
      slug: formData.get('slug') as string,
      description: formData.get('description') as string,
      longDescription: formData.get('longDescription') as string,
      instructorId,
      price: parseInt(formData.get('price') as string, 10),
      duration: parseInt(formData.get('duration') as string, 10),
      level: formData.get('level') as CourseLevel,
      category: formData.get('category') as string,
      imageUrl: formData.get('imageUrl') as string || undefined,
      thumbnailUrl: formData.get('thumbnailUrl') as string || undefined,
      previewVideoUrl: formData.get('previewVideoUrl') as string || undefined,
      tags: (formData.get('tags') as string)?.split(',').map(tag => tag.trim()) || [],
      learningOutcomes: (formData.get('learningOutcomes') as string)
        ?.split('\n')
        .map(outcome => outcome.trim())
        .filter(Boolean) || [],
      prerequisites: (formData.get('prerequisites') as string)
        ?.split('\n')
        .map(prereq => prereq.trim())
        .filter(Boolean) || [],
      isPublished: formData.get('isPublished') === 'on',
      isFeatured: formData.get('isFeatured') === 'on'
    };

    // Create course via API
    const response = await fetch('/api/courses', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer session', // Session-based auth, handled by cookies
      },
      body: JSON.stringify(data),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to create course');
    }
    
    const result = await response.json();
    
    // Show success message
    toast.success('Course created successfully');
    
    // Redirect to course list
    window.location.href = '/admin/courses';
  } catch (error: any) {
    // Show error message
    toast.error(error.message || 'Failed to create course');
  }
  });
});
</script>