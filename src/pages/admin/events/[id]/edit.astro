---
/**
 * T088: Admin Event Edit Page
 * 
 * Edit existing event form with pre-populated data:
 * - Fetches event by ID from database
 * - Pre-fills all form fields including venue details
 * - Updates event via PUT /api/admin/events/:id
 * - Validates required fields and business rules client-side
 * - Admin authentication required
 */

import AdminLayout from '@/layouts/AdminLayout.astro';
import FileUpload from '@/components/FileUpload.astro';
import { getSessionFromRequest } from '@/lib/auth/session';
import { getEventById } from '@/lib/events';

export const prerender = false; // Enable SSR for authentication

// Check authentication
const session = await getSessionFromRequest(Astro.cookies);
if (!session) {
  const currentPath = encodeURIComponent(Astro.url.pathname);
  return Astro.redirect(`/login?redirect=${currentPath}`);
}

// Get event ID from URL params
const { id } = Astro.params;
if (!id) {
  return Astro.redirect('/admin/events');
}

// Fetch event data
let event;
try {
  event = await getEventById(id);
} catch (error) {
  console.error('Error fetching event:', error);
  return Astro.redirect('/admin/events?error=event_not_found');
}

// Format date for datetime-local input (YYYY-MM-DDTHH:mm)
const formatDateTimeLocal = (date: Date): string => {
  const d = new Date(date);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const hours = String(d.getHours()).padStart(2, '0');
  const minutes = String(d.getMinutes()).padStart(2, '0');
  return `${year}-${month}-${day}T${hours}:${minutes}`;
};

const formattedEventDate = formatDateTimeLocal(event.event_date);
---

<AdminLayout title={`Edit Event: ${event.title}`}>
  <div class="max-w-5xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-sm border">
      <div class="px-6 py-4 border-b">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Edit Event</h1>
            <p class="text-sm text-gray-600 mt-1">Update the event details</p>
          </div>
          <a 
            href="/admin/events" 
            class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"
          >
            Back to Events
          </a>
        </div>
      </div>
      
      <form id="eventForm" class="p-6 space-y-8" data-event-id={event.id}>
        {/* Basic Information */}
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Basic Information
          </h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
                Event Title <span class="text-red-600">*</span>
              </label>
              <input 
                type="text" 
                id="title"
                name="title"
                required
                value={event.title}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="e.g., Spiritual Awakening Workshop"
              />
            </div>
            
            <div class="md:col-span-2">
              <label for="slug" class="block text-sm font-medium text-gray-700 mb-1">
                URL Slug <span class="text-red-600">*</span>
              </label>
              <input 
                type="text" 
                id="slug"
                name="slug"
                required
                value={event.slug}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="spiritual-awakening-workshop"
              />
              <p class="mt-1 text-xs text-gray-500">Auto-generated from title (editable)</p>
            </div>
          </div>

          <div>
            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
              Description <span class="text-red-600">*</span>
            </label>
            <textarea 
              id="description"
              name="description"
              required
              rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
              placeholder="Describe your event in detail..."
            >{event.description}</textarea>
          </div>
        </div>

        {/* Event Details */}
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Event Details
          </h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="price" class="block text-sm font-medium text-gray-700 mb-1">
                Price ($) <span class="text-red-600">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-gray-500">$</span>
                <input 
                  type="number" 
                  id="price"
                  name="price"
                  required
                  min="0"
                  step="0.01"
                  value={typeof event.price === 'string' ? parseFloat(event.price) : event.price}
                  class="w-full pl-7 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                  placeholder="99.00"
                />
              </div>
              <p class="mt-1 text-xs text-gray-500">Enter 0 for free events</p>
            </div>

            <div>
              <label for="event_date" class="block text-sm font-medium text-gray-700 mb-1">
                Event Date & Time <span class="text-red-600">*</span>
              </label>
              <input 
                type="datetime-local" 
                id="event_date"
                name="event_date"
                required
                value={formattedEventDate}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
              />
            </div>

            <div>
              <label for="duration_hours" class="block text-sm font-medium text-gray-700 mb-1">
                Duration (hours) <span class="text-red-600">*</span>
              </label>
              <input 
                type="number" 
                id="duration_hours"
                name="duration_hours"
                required
                min="0.5"
                step="0.5"
                value={event.duration_hours}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="2.0"
              />
              <p class="mt-1 text-xs text-gray-500">Enter 0.5 for 30 minutes</p>
            </div>

            <div>
              <label for="capacity" class="block text-sm font-medium text-gray-700 mb-1">
                Total Capacity <span class="text-red-600">*</span>
              </label>
              <input 
                type="number" 
                id="capacity"
                name="capacity"
                required
                min="1"
                value={event.capacity}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="50"
              />
            </div>

            <div>
              <label for="available_spots" class="block text-sm font-medium text-gray-700 mb-1">
                Available Spots <span class="text-red-600">*</span>
              </label>
              <input 
                type="number" 
                id="available_spots"
                name="available_spots"
                required
                min="0"
                value={event.available_spots}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="50"
              />
              <p class="mt-1 text-xs text-gray-500">Cannot exceed total capacity</p>
            </div>
          </div>
        </div>

        {/* Venue Information */}
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Venue Information
          </h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label for="venue_name" class="block text-sm font-medium text-gray-700 mb-1">
                Venue Name <span class="text-red-600">*</span>
              </label>
              <input 
                type="text" 
                id="venue_name"
                name="venue_name"
                required
                value={event.venue_name}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="e.g., Serenity Wellness Center"
              />
            </div>

            <div class="md:col-span-2">
              <label for="venue_address" class="block text-sm font-medium text-gray-700 mb-1">
                Street Address <span class="text-red-600">*</span>
              </label>
              <textarea 
                id="venue_address"
                name="venue_address"
                required
                rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="123 Main Street, Suite 100"
              >{event.venue_address}</textarea>
            </div>

            <div>
              <label for="venue_city" class="block text-sm font-medium text-gray-700 mb-1">
                City <span class="text-red-600">*</span>
              </label>
              <input 
                type="text" 
                id="venue_city"
                name="venue_city"
                required
                value={event.venue_city}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="San Francisco"
              />
            </div>

            <div>
              <label for="venue_country" class="block text-sm font-medium text-gray-700 mb-1">
                Country <span class="text-red-600">*</span>
              </label>
              <input 
                type="text" 
                id="venue_country"
                name="venue_country"
                required
                value={event.venue_country}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                placeholder="United States"
              />
            </div>
          </div>

          {/* Optional Coordinates */}
          <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div class="flex-1">
                <h3 class="text-sm font-medium text-blue-900 mb-1">
                  Optional: Coordinates for Map Display
                </h3>
                <p class="text-sm text-blue-700 mb-3">
                  Add latitude and longitude to show the venue location on an interactive map
                </p>
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="venue_lat" class="block text-xs font-medium text-blue-900 mb-1">
                      Latitude
                    </label>
                    <input 
                      type="number" 
                      id="venue_lat"
                      name="venue_lat"
                      step="0.000001"
                      value={event.venue_lat ? (typeof event.venue_lat === 'string' ? parseFloat(event.venue_lat) : event.venue_lat) : ''}
                      class="w-full px-3 py-2 bg-white border border-blue-200 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm"
                      placeholder="37.7749"
                    />
                  </div>
                  
                  <div>
                    <label for="venue_lng" class="block text-xs font-medium text-blue-900 mb-1">
                      Longitude
                    </label>
                    <input 
                      type="number" 
                      id="venue_lng"
                      name="venue_lng"
                      step="0.000001"
                      value={event.venue_lng ? (typeof event.venue_lng === 'string' ? parseFloat(event.venue_lng) : event.venue_lng) : ''}
                      class="w-full px-3 py-2 bg-white border border-blue-200 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm"
                      placeholder="-122.4194"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Media */}
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Media
          </h2>

          <FileUpload
            name="image_url"
            label="Event Image"
            accept="image/*"
            maxSize={10 * 1024 * 1024}
            currentValue={event.image_url}
            helpText="Upload the main event image (max 10MB). Recommended: 1200x630px"
            folder="events/images"
          />
        </div>

        {/* Publication Status */}
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Publication Status
          </h2>
          
          <label class="inline-flex items-center">
            <input 
              type="checkbox" 
              name="is_published"
              checked={event.is_published}
              class="rounded border-gray-300 text-purple-600 focus:ring-purple-500"
            />
            <span class="ml-2 text-sm text-gray-700">Publish this event (make it visible to users)</span>
          </label>
        </div>

        {/* Submit */}
        <div class="flex gap-4 justify-end pt-4 border-t">
          <a
            href="/admin/events"
            class="px-6 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"
          >
            Cancel
          </a>
          <button
            type="submit"
            id="submitBtn"
            class="px-6 py-2 text-white bg-purple-600 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
          >
            <span id="submitText">Update Event</span>
            <svg id="submitSpinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<!-- Inline script for slug generation and capacity sync -->
<script is:inline>
document.addEventListener('DOMContentLoaded', () => {
  const titleInput = document.getElementById('title');
  const slugInput = document.getElementById('slug');

  function generateSlug(text) {
    return text
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-|-$/g, '');
  }

  if (titleInput && slugInput) {
    // Initialize previousValue with the current title on page load
    titleInput.dataset.previousValue = titleInput.value;
    
    // Only auto-generate slug if it's currently empty or matches the auto-generated pattern
    titleInput.addEventListener('input', () => {
      const currentSlug = slugInput.value;
      const autoSlug = generateSlug(titleInput.value);
      
      // Update slug if it's empty or if it looks auto-generated from the previous title
      if (!currentSlug || currentSlug === generateSlug(titleInput.dataset.previousValue || '')) {
        slugInput.value = autoSlug;
      }
      
      titleInput.dataset.previousValue = titleInput.value;
    });
  }

  // Note: For edit form, we don't auto-sync capacity and available_spots
  // because they represent current state (with potential bookings)
  // Admin must manually adjust if needed
});
</script>

<script>
import { useToast } from '@/lib/toast';

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('eventForm') as HTMLFormElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
  const submitText = document.getElementById('submitText') as HTMLSpanElement;
  const submitSpinner = document.getElementById('submitSpinner') as SVGElement;
  const toast = useToast();

  if (!form) {
    console.error('Event form not found!');
    return;
  }

  function setLoading(loading: boolean) {
    if (submitBtn && submitText && submitSpinner) {
      submitBtn.disabled = loading;
      submitText.textContent = loading ? 'Updating...' : 'Update Event';
      submitSpinner.classList.toggle('hidden', !loading);
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Manual validation for required fields
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    let firstInvalidField: HTMLElement | null = null;

    requiredFields.forEach((field) => {
      const input = field as HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement;
      if (!input.value.trim()) {
        input.setAttribute('aria-invalid', 'true');
        input.classList.add('border-red-500', 'ring-2', 'ring-red-500');
        isValid = false;
        if (!firstInvalidField) {
          firstInvalidField = input;
        }
      } else {
        input.removeAttribute('aria-invalid');
        input.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
      }
    });

    if (!isValid && firstInvalidField) {
      firstInvalidField.focus();
      toast.error('Please fill in all required fields');
      return;
    }

    // Validate capacity constraint
    const capacityInput = document.getElementById('capacity') as HTMLInputElement;
    const availableSpotsInput = document.getElementById('available_spots') as HTMLInputElement;
    const capacity = parseInt(capacityInput.value);
    const availableSpots = parseInt(availableSpotsInput.value);

    if (availableSpots > capacity) {
      availableSpotsInput.classList.add('border-red-500', 'ring-2', 'ring-red-500');
      availableSpotsInput.focus();
      toast.error('Available spots cannot exceed total capacity');
      return;
    }

    setLoading(true);

    try {
      const formData = new FormData(form);

      // Get event ID from form data attribute
      const eventId = form.dataset.eventId;

      if (!eventId) {
        throw new Error('Event ID not found');
      }

      // Parse form data into API payload
      const data = {
        title: formData.get('title') as string,
        slug: formData.get('slug') as string,
        description: formData.get('description') as string,
        price: parseFloat(formData.get('price') as string),
        event_date: new Date(formData.get('event_date') as string).toISOString(),
        duration_hours: parseFloat(formData.get('duration_hours') as string),
        venue_name: formData.get('venue_name') as string,
        venue_address: formData.get('venue_address') as string,
        venue_city: formData.get('venue_city') as string,
        venue_country: formData.get('venue_country') as string,
        venue_lat: formData.get('venue_lat') ? parseFloat(formData.get('venue_lat') as string) : undefined,
        venue_lng: formData.get('venue_lng') ? parseFloat(formData.get('venue_lng') as string) : undefined,
        capacity: parseInt(formData.get('capacity') as string, 10),
        available_spots: parseInt(formData.get('available_spots') as string, 10),
        image_url: formData.get('image_url') as string || undefined,
        is_published: formData.get('is_published') === 'on'
      };

      // Update event via API
      const response = await fetch(`/api/admin/events/${eventId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to update event');
      }

      const result = await response.json();

      // Show success message
      toast.success('Event updated successfully');

      // Redirect to event list after a brief delay
      setTimeout(() => {
        window.location.href = '/admin/events';
      }, 1000);
    } catch (error: any) {
      console.error('Error updating event:', error);
      setLoading(false);
      // Show error message
      toast.error(error.message || 'Failed to update event');
    }
  });
});
</script>
