---
/**
 * T065: Admin Dashboard Page
 *
 * Main administrative dashboard displaying:
 * - Key business metrics (courses, users, orders, revenue)
 * - Monthly trends and growth indicators
 * - Recent activity feed
 * - Course performance statistics
 * - Quick action shortcuts
 */

import AdminLayout from '@/layouts/AdminLayout.astro';
import { getAdminStats } from '@/services/admin-stats.service';
import { initEnv } from '@/lib/env';

export const prerender = false;

// Initialize environment from Cloudflare runtime
const runtime = (Astro.locals as any).runtime;
if (runtime?.env) {
  initEnv(runtime.env);
  console.log('[ADMIN] Environment initialized from Cloudflare runtime');
} else {
  console.warn('[ADMIN] No Cloudflare runtime env available - running in local/dev mode?');
}

// Fetch admin statistics
let stats;
let error = null;

try {
  stats = await getAdminStats();
} catch (e) {
  error = e.message;
  console.error('Failed to load admin stats:', e);
  
  // Provide fallback data for development/demo
  stats = {
    overview: {
      totalCourses: 0,
      publishedCourses: 0,
      totalUsers: 0,
      totalOrders: 0,
      totalRevenue: 0,
      pendingOrders: 0,
    },
    trends: {
      newUsersThisMonth: 0,
      newCoursesThisMonth: 0,
      ordersThisMonth: 0,
      revenueThisMonth: 0,
      growthMetrics: {
        userGrowth: 0,
        courseGrowth: 0,
        revenueGrowth: 0,
      },
    },
    recentActivity: {
      recentOrders: [],
      recentUsers: [],
    },
    courseStats: {
      topCourses: [],
      coursesByCategory: [],
    },
  };
}

// Helper functions for formatting
function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(amount);
}

function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}

function getGrowthIcon(growth: number): string {
  if (growth > 0) return 'ğŸ“ˆ';
  if (growth < 0) return 'ğŸ“‰';
  return 'â–';
}

function getGrowthClass(growth: number): string {
  if (growth > 0) return 'text-success';
  if (growth < 0) return 'text-error';
  return 'text-text-light';
}
---

<AdminLayout 
  title="Dashboard" 
  description="Administrative overview and key metrics"
>
  <!-- Error Banner -->
  {error && (
    <div class="mb-6 bg-error-light border border-error/30 rounded-lg p-4" data-testid="error-banner">
      <div class="flex items-center">
        <span class="text-error text-lg mr-2">âš ï¸</span>
        <div>
          <h3 class="text-sm font-medium text-error">Error Loading Statistics</h3>
          <p class="text-sm text-error/80 mt-1">{error}</p>
          <p class="text-xs text-error/60 mt-2">Showing fallback data. Please check database connection.</p>
        </div>
      </div>
    </div>
  )}

  <!-- Quick Actions Bar -->
  <div class="mb-8 bg-surface rounded-lg shadow-sm border border-border p-4">
    <h2 class="text-lg font-semibold text-text mb-4">Quick Actions</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <a
        href="/admin/courses/new"
        class="flex items-center justify-center p-4 bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition-colors group"
        data-testid="quick-action-new-course"
      >
        <span class="text-2xl mr-2 group-hover:scale-110 transition-transform">â•</span>
        <span class="font-medium">New Course</span>
      </a>

      <a
        href="/admin/orders?status=pending"
        class="flex items-center justify-center p-4 bg-warning/10 text-warning rounded-lg hover:bg-warning/20 transition-colors group"
        data-testid="quick-action-pending-orders"
      >
        <span class="text-2xl mr-2 group-hover:scale-110 transition-transform">ğŸ“‹</span>
        <span class="font-medium">Pending Orders</span>
        {stats.overview.pendingOrders > 0 && (
          <span class="ml-2 bg-warning/20 text-warning text-xs font-bold px-2 py-1 rounded-full">
            {stats.overview.pendingOrders}
          </span>
        )}
      </a>

      <a
        href="/admin/analytics"
        class="flex items-center justify-center p-4 bg-info/10 text-info rounded-lg hover:bg-info/20 transition-colors group"
        data-testid="quick-action-analytics"
      >
        <span class="text-2xl mr-2 group-hover:scale-110 transition-transform">ğŸ“Š</span>
        <span class="font-medium">Analytics</span>
      </a>

      <a
        href="/admin/users"
        class="flex items-center justify-center p-4 bg-success/10 text-success rounded-lg hover:bg-success/20 transition-colors group"
        data-testid="quick-action-users"
      >
        <span class="text-2xl mr-2 group-hover:scale-110 transition-transform">ğŸ‘¥</span>
        <span class="font-medium">Manage Users</span>
      </a>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
      <a
        href="/admin/events"
        class="flex items-center justify-center p-4 bg-secondary/10 text-secondary rounded-lg hover:bg-secondary/20 transition-colors group"
        data-testid="quick-action-events"
      >
        <span class="text-2xl mr-2 group-hover:scale-110 transition-transform">ğŸ“…</span>
        <span class="font-medium">Events</span>
      </a>

      <a
        href="/admin/products"
        class="flex items-center justify-center p-4 bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition-colors group"
        data-testid="quick-action-products"
      >
        <span class="text-2xl mr-2 group-hover:scale-110 transition-transform">ğŸ›ï¸</span>
        <span class="font-medium">Products</span>
      </a>

      <a
        href="/admin/orders"
        class="flex items-center justify-center p-4 bg-warning/10 text-warning rounded-lg hover:bg-warning/20 transition-colors group"
        data-testid="quick-action-orders"
      >
        <span class="text-2xl mr-2 group-hover:scale-110 transition-transform">ğŸ“¦</span>
        <span class="font-medium">All Orders</span>
      </a>

      <a
        href="/courses"
        class="flex items-center justify-center p-4 bg-surface-dark text-text-light rounded-lg hover:bg-border transition-colors group"
        data-testid="quick-action-view-site"
      >
        <span class="text-2xl mr-2 group-hover:scale-110 transition-transform">ğŸŒ</span>
        <span class="font-medium">View Site</span>
      </a>
    </div>
  </div>

  <!-- Overview Stats Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Courses -->
    <div class="bg-surface rounded-lg shadow-sm border border-border p-6" data-testid="stat-total-courses">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-text-light">Total Courses</p>
          <p class="text-3xl font-bold text-text">{stats.overview.totalCourses}</p>
          <p class="text-sm text-text-light mt-1">
            {stats.overview.publishedCourses} published
          </p>
        </div>
        <div class="text-4xl">ğŸ“š</div>
      </div>
      {stats.trends.newCoursesThisMonth > 0 && (
        <div class="mt-4 flex items-center text-sm">
          <span class="text-success">+{stats.trends.newCoursesThisMonth}</span>
          <span class="text-text-light ml-1">this month</span>
        </div>
      )}
    </div>

    <!-- Total Users -->
    <div class="bg-surface rounded-lg shadow-sm border border-border p-6" data-testid="stat-total-users">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-text-light">Total Users</p>
          <p class="text-3xl font-bold text-text">{stats.overview.totalUsers}</p>
          <p class="text-sm text-text-light mt-1">
            Registered learners
          </p>
        </div>
        <div class="text-4xl">ğŸ‘¥</div>
      </div>
      {stats.trends.newUsersThisMonth > 0 && (
        <div class="mt-4 flex items-center text-sm">
          <span class={getGrowthClass(stats.trends.growthMetrics.userGrowth)}>
            {getGrowthIcon(stats.trends.growthMetrics.userGrowth)}
            +{stats.trends.newUsersThisMonth}
          </span>
          <span class="text-text-light ml-1">this month</span>
          {stats.trends.growthMetrics.userGrowth !== 0 && (
            <span class={`ml-2 text-xs ${getGrowthClass(stats.trends.growthMetrics.userGrowth)}`}>
              ({stats.trends.growthMetrics.userGrowth > 0 ? '+' : ''}{stats.trends.growthMetrics.userGrowth.toFixed(1)}%)
            </span>
          )}
        </div>
      )}
    </div>

    <!-- Total Orders -->
    <div class="bg-surface rounded-lg shadow-sm border border-border p-6" data-testid="stat-total-orders">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-text-light">Total Orders</p>
          <p class="text-3xl font-bold text-text">{stats.overview.totalOrders}</p>
          <p class="text-sm text-text-light mt-1">
            {stats.overview.pendingOrders} pending
          </p>
        </div>
        <div class="text-4xl">ğŸ›’</div>
      </div>
      {stats.trends.ordersThisMonth > 0 && (
        <div class="mt-4 flex items-center text-sm">
          <span class="text-info">+{stats.trends.ordersThisMonth}</span>
          <span class="text-text-light ml-1">this month</span>
        </div>
      )}
    </div>

    <!-- Total Revenue -->
    <div class="bg-surface rounded-lg shadow-sm border border-border p-6" data-testid="stat-total-revenue">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-text-light">Total Revenue</p>
          <p class="text-3xl font-bold text-text">{formatCurrency(stats.overview.totalRevenue)}</p>
          <p class="text-sm text-text-light mt-1">
            All time earnings
          </p>
        </div>
        <div class="text-4xl">ğŸ’°</div>
      </div>
      {stats.trends.revenueThisMonth > 0 && (
        <div class="mt-4 flex items-center text-sm">
          <span class={getGrowthClass(stats.trends.growthMetrics.revenueGrowth)}>
            {getGrowthIcon(stats.trends.growthMetrics.revenueGrowth)}
            {formatCurrency(stats.trends.revenueThisMonth)}
          </span>
          <span class="text-text-light ml-1">this month</span>
          {stats.trends.growthMetrics.revenueGrowth !== 0 && (
            <span class={`ml-2 text-xs ${getGrowthClass(stats.trends.growthMetrics.revenueGrowth)}`}>
              ({stats.trends.growthMetrics.revenueGrowth > 0 ? '+' : ''}{stats.trends.growthMetrics.revenueGrowth.toFixed(1)}%)
            </span>
          )}
        </div>
      )}
    </div>
  </div>

  <!-- Content Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Recent Orders -->
    <div class="bg-surface rounded-lg shadow-sm border border-border p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-text">Recent Orders</h3>
        <a
          href="/admin/orders"
          class="text-sm text-primary hover:text-primary-dark font-medium"
          data-testid="view-all-orders"
        >
          View all â†’
        </a>
      </div>

      {stats.recentActivity.recentOrders.length > 0 ? (
        <div class="space-y-3" data-testid="recent-orders-list">
          {stats.recentActivity.recentOrders.map((order) => (
            <div key={order.id} class="flex items-center justify-between p-3 bg-surface-dark rounded-lg">
              <div class="flex-1">
                <div class="flex items-center space-x-2">
                  <span class="font-medium text-text">{order.userEmail}</span>
                  <span class={`px-2 py-1 text-xs font-medium rounded-full ${
                    order.status === 'completed' ? 'bg-success-light text-success' :
                    order.status === 'pending' ? 'bg-warning-light text-warning' :
                    'bg-surface-dark text-text-light'
                  }`}>
                    {order.status}
                  </span>
                </div>
                <div class="text-sm text-text-light mt-1">
                  {order.itemCount} item{order.itemCount !== 1 ? 's' : ''} â€¢ {formatDate(order.createdAt)}
                </div>
              </div>
              <div class="text-right">
                <div class="font-semibold text-text">{formatCurrency(order.totalAmount)}</div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-8 text-text-light" data-testid="no-recent-orders">
          <span class="text-4xl">ğŸ“‹</span>
          <p class="mt-2">No recent orders</p>
        </div>
      )}
    </div>

    <!-- Recent Users -->
    <div class="bg-surface rounded-lg shadow-sm border border-border p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-text">Recent Users</h3>
        <a
          href="/admin/users"
          class="text-sm text-primary hover:text-primary-dark font-medium"
          data-testid="view-all-users"
        >
          View all â†’
        </a>
      </div>

      {stats.recentActivity.recentUsers.length > 0 ? (
        <div class="space-y-3" data-testid="recent-users-list">
          {stats.recentActivity.recentUsers.map((user) => (
            <div key={user.id} class="flex items-center space-x-3 p-3 bg-surface-dark rounded-lg">
              <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                <span class="text-primary font-semibold text-sm">
                  {user.name.charAt(0).toUpperCase()}
                </span>
              </div>
              <div class="flex-1">
                <div class="font-medium text-text">{user.name}</div>
                <div class="text-sm text-text-light">{user.email}</div>
              </div>
              <div class="text-xs text-text-light">
                {formatDate(user.createdAt)}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-8 text-text-light" data-testid="no-recent-users">
          <span class="text-4xl">ğŸ‘¥</span>
          <p class="mt-2">No recent users</p>
        </div>
      )}
    </div>

    <!-- Top Courses -->
    <div class="bg-surface rounded-lg shadow-sm border border-border p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-text">Top Courses</h3>
        <a
          href="/admin/courses"
          class="text-sm text-primary hover:text-primary-dark font-medium"
          data-testid="view-all-courses"
        >
          Manage â†’
        </a>
      </div>

      {stats.courseStats.topCourses.length > 0 ? (
        <div class="space-y-3" data-testid="top-courses-list">
          {stats.courseStats.topCourses.map((course, index) => (
            <div key={course.id} class="flex items-center justify-between p-3 bg-surface-dark rounded-lg">
              <div class="flex items-center space-x-3">
                <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white text-sm font-bold">
                  {index + 1}
                </div>
                <div>
                  <div class="font-medium text-text">{course.title}</div>
                  <div class="text-sm text-text-light">
                    {course.enrollments} enrollment{course.enrollments !== 1 ? 's' : ''}
                  </div>
                </div>
              </div>
              <div class="text-right">
                <div class="font-semibold text-text">{formatCurrency(course.revenue)}</div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-8 text-text-light" data-testid="no-courses">
          <span class="text-4xl">ğŸ“š</span>
          <p class="mt-2">No courses yet</p>
          <a href="/admin/courses/new" class="mt-2 text-sm text-primary hover:text-primary-dark">
            Create your first course
          </a>
        </div>
      )}
    </div>

    <!-- Course Categories -->
    <div class="bg-surface rounded-lg shadow-sm border border-border p-6">
      <h3 class="text-lg font-semibold text-text mb-4">Course Categories</h3>

      {stats.courseStats.coursesByCategory.length > 0 ? (
        <div class="space-y-3" data-testid="course-categories-list">
          {stats.courseStats.coursesByCategory.map((category) => (
            <div key={category.category} class="flex items-center justify-between">
              <span class="text-text capitalize">{category.category}</span>
              <span class="bg-surface-dark text-text-light px-3 py-1 rounded-full text-sm font-medium">
                {category.count}
              </span>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-8 text-text-light" data-testid="no-categories">
          <span class="text-4xl">ğŸ·ï¸</span>
          <p class="mt-2">No categories yet</p>
        </div>
      )}
    </div>
  </div>

  <!-- Admin Actions Footer -->
  <div class="mt-8 bg-gradient-to-r from-primary/5 to-secondary/5 rounded-lg p-6 border border-primary/20">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold text-text">Admin Tools</h3>
        <p class="text-sm text-text-light mt-1">Manage your platform and content</p>
      </div>
      <div class="flex space-x-3">
        <a
          href="/admin/settings"
          class="bg-surface text-text-light px-4 py-2 rounded-lg border border-border hover:bg-surface-dark transition-colors text-sm font-medium"
          data-testid="admin-settings"
        >
          âš™ï¸ Settings
        </a>
        <a
          href="/admin/analytics"
          class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark transition-colors text-sm font-medium"
          data-testid="admin-analytics"
        >
          ğŸ“Š View Analytics
        </a>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // Add interactivity to dashboard
  document.addEventListener('DOMContentLoaded', () => {
    // Add hover effects to stat cards
    const statCards = document.querySelectorAll('[data-testid^="stat-"]');
    statCards.forEach(card => {
      card.addEventListener('mouseenter', () => {
        card.style.transform = 'translateY(-2px)';
        card.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.1)';
      });
      card.addEventListener('mouseleave', () => {
        card.style.transform = 'translateY(0)';
        card.style.boxShadow = '';
      });
    });

    // Auto-refresh every 30 seconds for live stats
    setInterval(() => {
      // Only refresh if user is still on the page and active
      if (!document.hidden && document.hasFocus()) {
        // Subtle indication of refresh (optional)
        const refreshIndicator = document.createElement('div');
        refreshIndicator.className = 'fixed top-4 right-4 bg-success text-white px-3 py-1 rounded-full text-xs z-50';
        refreshIndicator.textContent = 'ğŸ“Š Updated';
        document.body.appendChild(refreshIndicator);
        
        setTimeout(() => {
          refreshIndicator.remove();
        }, 2000);
        
        // In a real app, you would make an API call here to update stats
        // For now, we'll just show the indicator
      }
    }, 30000); // 30 seconds
  });
</script>