---
/**
 * Courses Catalog Page
 * Browse all courses with advanced filtering by category, price, level, and rating
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import CourseCard from '../../components/CourseCard.astro';
import CourseFilters from '../../components/CourseFilters.astro';
import { getCourses, getCategories } from '../../lib/courses';
import { getLocalizedCourses } from '../../lib/coursesI18n';
import { useTranslations } from '@/lib/pageTranslations';

// Get locale from middleware (T168)
const locale = Astro.locals.locale || 'es';
const { t } = useTranslations(Astro.locals);

// Extract URL parameters
const url = new URL(Astro.request.url);
const category = url.searchParams.get('category') || 'all';
const level = url.searchParams.get('level') || 'all';
const minPrice = url.searchParams.get('minPrice') || '';
const maxPrice = url.searchParams.get('maxPrice') || '';
const minRating = url.searchParams.get('minRating') || '';
const search = url.searchParams.get('search') || '';
const limit = parseInt(url.searchParams.get('limit') || '12');
const page = parseInt(url.searchParams.get('page') || '1');
const offset = (page - 1) * limit;

// Fetch localized courses with filters (T168)
let courses = { items: [], total: 0, hasMore: false };
let error = null;

try {
  courses = await getLocalizedCourses({
    category: category !== 'all' ? category : undefined,
    level: level !== 'all' ? level : undefined,
    minPrice: minPrice ? parseFloat(minPrice) : undefined,
    maxPrice: maxPrice ? parseFloat(maxPrice) : undefined,
    minRating: minRating ? parseFloat(minRating) : undefined,
    search: search || undefined,
    limit,
    offset,
    locale,
  });
} catch (err) {
  console.error('[T168] Error fetching localized courses:', err);
  // Fallback to non-localized version if localized fails
  try {
    courses = await getCourses({
      category: category !== 'all' ? category : undefined,
      level: level !== 'all' ? level : undefined,
      minPrice: minPrice ? parseFloat(minPrice) : undefined,
      maxPrice: maxPrice ? parseFloat(maxPrice) : undefined,
      minRating: minRating ? parseFloat(minRating) : undefined,
      search: search || undefined,
      limit,
      offset,
    });
  } catch (fallbackErr) {
    console.error('Error fetching courses (fallback):', fallbackErr);
    error = 'Failed to load courses. Please try again later.';
  }
}

// Fetch available categories for filter
let categories: string[] = [];
try {
  categories = await getCategories();
} catch (err) {
  console.error('Error fetching categories:', err);
}

// Calculate pagination
const currentPage = page;
const totalPages = Math.ceil(courses.total / limit);
const hasNextPage = courses.hasMore;
const hasPrevPage = currentPage > 1;

// Helper to build URLs with filters preserved
function buildPageUrl(pageNum: number): string {
  const params = new URLSearchParams();
  params.set('page', pageNum.toString());
  params.set('limit', limit.toString());
  
  if (category !== 'all') params.set('category', category);
  if (level !== 'all') params.set('level', level);
  if (minPrice) params.set('minPrice', minPrice);
  if (maxPrice) params.set('maxPrice', maxPrice);
  if (minRating) params.set('minRating', minRating);
  if (search) params.set('search', search);
  
  return `/courses?${params.toString()}`;
}

// Active filter count
const activeFilterCount = [
  category !== 'all',
  level !== 'all',
  minPrice !== '',
  maxPrice !== '',
  minRating !== '',
].filter(Boolean).length;

// Compute page numbers for pagination (done in frontmatter to avoid JSX issues with < >)
const computeCoursePageNumbers = (): Array<{ pageNum: number; showPage: boolean; showEllipsis: boolean }> => {
  const pages = [];

  for (let i = 0; i < totalPages; i++) {
    const pageNum = i + 1;
    const showPage =
      pageNum === 1 ||
      pageNum === totalPages ||
      Math.abs(pageNum - currentPage) <= 2;

    const showEllipsis = !showPage && (pageNum === currentPage - 3 || pageNum === currentPage + 3);

    pages.push({ pageNum, showPage, showEllipsis });
  }

  return pages;
};

const coursePageNumbers = computeCoursePageNumbers();
---

<BaseLayout title="Online Courses | Spirituality E-Commerce">
  <div class="min-h-screen bg-surface">
    <div class="container mx-auto px-md py-2xl">
      <!-- Header Section -->
      <div class="mb-2xl">
        <h1 class="mb-sm text-3xl font-bold text-text">
          {t('courses.browseCourses')}
        </h1>
        <p class="text-text-light">
          {t('courses.browseDescription')}
        </p>

        {activeFilterCount > 0 && (
          <p class="mt-sm text-sm text-text">
            <span class="font-medium">{activeFilterCount}</span> {activeFilterCount === 1 ? t('courses.filterActive', { count: '' }).replace('  ', ' ').trim() : t('courses.filtersActive', { count: '' }).replace('  ', ' ').trim()}
          </p>
        )}
      </div>

      {error ? (
        <!-- Error State -->
        <div class="rounded-lg border border-error/20 bg-error-light p-xl text-center">
          <svg
            class="mx-auto mb-md h-12 w-12 text-error"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            />
          </svg>
          <h2 class="mb-sm text-xl font-semibold text-error">{t('courses.errorLoading')}</h2>
          <p class="text-error">{error}</p>
        </div>
      ) : (
        <!-- Main Content: Filters + Course Grid -->
        <div class="flex flex-col gap-2xl lg:flex-row">
          <!-- Filter Sidebar -->
          <CourseFilters
            currentCategory={category}
            currentLevel={level}
            currentMinPrice={minPrice}
            currentMaxPrice={maxPrice}
            currentMinRating={minRating}
            categories={categories}
          />

          <!-- Course Grid -->
          <main class="flex-1">
            <!-- Results Header -->
            <div class="mb-lg flex items-center justify-between">
              <p class="text-sm text-text-light">
                {courses.total === 0 ? t('courses.noCoursesFound') :
                 courses.total === 1
                   ? t('courses.showingCourseSingular', { start: offset + 1, end: Math.min(offset + limit, courses.total), total: courses.total })
                   : t('courses.showingCourses', { start: offset + 1, end: Math.min(offset + limit, courses.total), total: courses.total })}
              </p>
            </div>

            {courses.items.length === 0 ? (
              <!-- Empty State -->
              <div class="rounded-lg border border-border bg-background p-3xl text-center">
                <svg
                  class="mx-auto mb-md h-16 w-16 text-text-lighter"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                  />
                </svg>
                <h2 class="mb-sm text-xl font-semibold text-text">
                  {t('courses.noCoursesFound')}
                </h2>
                <p class="mb-md text-text-light">
                  {t('courses.tryAdjustingFilters')}
                </p>
                <a
                  href="/courses"
                  class="inline-block rounded-md bg-primary px-xl py-sm text-white transition-colors hover:bg-primary-dark"
                >
                  {t('courses.clearAllFilters')}
                </a>
              </div>
            ) : (
              <>
                <!-- Course Grid -->
                <div class="mb-2xl grid grid-cols-1 gap-xl md:grid-cols-2 xl:grid-cols-3">
                  {courses.items.map((course) => (
                    <CourseCard course={course} />
                  ))}
                </div>

                <!-- Pagination -->
                {totalPages > 1 && (
                  <nav
                    class="flex items-center justify-center gap-sm"
                    aria-label="Pagination"
                  >
                    {/* Previous Button */}
                    {hasPrevPage ? (
                      <a
                        href={buildPageUrl(currentPage - 1)}
                        class="rounded-md border border-border px-md py-sm text-sm font-medium text-text transition-colors hover:bg-surface"
                      >
                        {t('pagination.previous')}
                      </a>
                    ) : (
                      <span class="cursor-not-allowed rounded-md border border-border px-md py-sm text-sm font-medium text-text-lighter">
                        {t('pagination.previous')}
                      </span>
                    )}

                    {/* Page Numbers (Desktop) */}
                    <div class="hidden gap-xs md:flex">
                      {coursePageNumbers.map((page) => {
                        if (!page.showPage) {
                          if (page.showEllipsis) {
                            return (
                              <span class="px-sm py-sm text-text-light">
                                ...
                              </span>
                            );
                          }
                          return null;
                        }

                        return (
                          <a
                            href={buildPageUrl(page.pageNum)}
                            class:list={[
                              'rounded-md border px-md py-sm text-sm font-medium transition-colors',
                              page.pageNum === currentPage
                                ? 'border-primary bg-primary text-white'
                                : 'border-border text-text hover:bg-surface'
                            ]}
                            aria-current={page.pageNum === currentPage ? 'page' : undefined}
                          >
                            {page.pageNum}
                          </a>
                        );
                      })}
                    </div>

                    {/* Page Indicator (Mobile) */}
                    <span class="px-md py-sm text-sm text-text md:hidden">
                      {t('pagination.page')} {currentPage} {t('pagination.of')} {totalPages}
                    </span>

                    {/* Next Button */}
                    {hasNextPage ? (
                      <a
                        href={buildPageUrl(currentPage + 1)}
                        class="rounded-md border border-border px-md py-sm text-sm font-medium text-text transition-colors hover:bg-surface"
                      >
                        {t('pagination.next')}
                      </a>
                    ) : (
                      <span class="cursor-not-allowed rounded-md border border-border px-md py-sm text-sm font-medium text-text-lighter">
                        {t('pagination.next')}
                      </span>
                    )}
                  </nav>
                )}
              </>
            )}
          </main>
        </div>
      )}
    </div>
  </div>
</BaseLayout>
